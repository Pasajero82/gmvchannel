<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMV - Generative Music Video</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">	
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
<style>
/* ========================================
   GMV - MODERN REDESIGN
   Cambios dramáticos en diseño visual
   ======================================== */

/* --- VARIABLES DE COLOR NUEVAS (PALETA OSCURA PREMIUM) --- */
:root {
	/* Colores primarios */
	--primary: #ff0066;        /* Rosa neón mexicano */
	--primary-dark: #cc0052;
	--primary-light: #ff3385;
	--primary-glow: rgba(255, 0, 102, 0.5);
    
    /* Colores secundarios */
    --secondary: #14b8a6;      /* Teal moderno (antes cyan) */
    --secondary-dark: #0d9488;
    --secondary-light: #2dd4bf;
    --secondary-glow: rgba(20, 184, 166, 0.4);
    
    /* Acento */
    --accent: #f59e0b;         /* Ámbar (antes oro) */
    --accent-glow: rgba(245, 158, 11, 0.4);
    
    /* Fondos - Sistema de capas */
    --bg-base: #0f0f0f;
    --bg-elevated-1: #1a1a1a;
    --bg-elevated-2: #252525;
    --bg-elevated-3: #303030;
    --bg-glass: rgba(26, 26, 26, 0.7);
    --bg-overlay: rgba(15, 15, 15, 0.95);
    
    /* Texto */
    --text-primary: #ffffff;
    --text-secondary: #a3a3a3;
    --text-tertiary: #737373;
    --text-disabled: #525252;
    
    /* Bordes y divisores */
    --border-subtle: rgba(255, 255, 255, 0.06);
    --border-default: rgba(255, 255, 255, 0.12);
    --border-strong: rgba(255, 255, 255, 0.18);
    
    /* Sombras */
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
    --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.7);
    
    /* Animaciones */
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 400ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);
    
    /* Espaciado consistente */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 16px;
    --space-lg: 24px;
    --space-xl: 32px;
    --space-2xl: 48px;
    
    /* Radios */
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --radius-xl: 20px;
    --radius-full: 9999px;
}

/* --- RESET Y BASE --- */
* { 
    margin: 0; 
    padding: 0; 
    box-sizing: border-box; 
}

body { 
    background: linear-gradient(135deg, #0a0a0f 0%, #151520 100%);
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
    margin: 0; 
    height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    overflow: hidden; 
    font-weight: 400;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.tv-frame { 
    position: relative; 
    width: 100vw; 
    height: 100vh; 
    background: var(--bg-base);
    overflow: hidden; 
}

#player { 
    width: 100%; 
    height: 100%; 
    pointer-events: auto; 
}

/* --- EFECTOS DE FONDO --- */
.vignette {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(
        ellipse at center, 
        transparent 0%, 
        transparent 50%, 
        rgba(0,0,0,0.3) 100%
    );
    pointer-events: none;
    z-index: 5;
}

/* Efecto de grano sutil */
.scanlines { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background-image: 
        repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.03) 0px,
            transparent 1px,
            transparent 2px,
            rgba(0, 0, 0, 0.03) 3px
        );
    pointer-events: none; 
    z-index: 20;
    opacity: 0.4;
    mix-blend-mode: overlay;
}

.crt-effect {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 25;
    background: radial-gradient(
        ellipse at center, 
        transparent 60%, 
        rgba(99, 102, 241, 0.02) 100%
    );
}

/* --- PANTALLA DE INICIO (COMPLETAMENTE REDISEÑADA) --- */
#start-screen { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 50%, #16213e 100%);
    z-index: 100; 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    align-items: center; 
    transition: opacity 0.8s var(--transition-slow);
}

/* Fondo animado con partículas */
#start-screen::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(20, 184, 166, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(245, 158, 11, 0.06) 0%, transparent 50%);
    animation: particleFloat 20s ease-in-out infinite;
}

@keyframes particleFloat {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.1); }
}

.logo-container { 
    position: relative; 
    width: 280px; 
    height: 280px; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    margin-bottom: var(--space-2xl);
}

.start-logo { 
    width: 200px; 
    height: auto; 
    position: relative; 
    z-index: 10; 
    animation: logoFloat 4s ease-in-out infinite;
    filter: drop-shadow(0 10px 40px var(--primary-glow));
}

@keyframes logoFloat { 
    0%, 100% { 
        transform: translateY(0px) scale(1);
        filter: drop-shadow(0 10px 40px var(--primary-glow));
    } 
    50% { 
        transform: translateY(-12px) scale(1.02);
        filter: drop-shadow(0 15px 50px var(--primary-glow));
    } 
}

/* Anillos rediseñados - Estilo moderno */
.ring { 
    position: absolute; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    border-radius: 50%; 
    opacity: 0; 
    z-index: 1; 
    pointer-events: none; 
}

.ring-1 { 
    border: 2px solid var(--primary);
    animation: rippleModern 5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    box-shadow: 0 0 30px var(--primary-glow);
}

.ring-2 { 
    border: 2px solid var(--secondary);
    animation: rippleModern 5s cubic-bezier(0.4, 0, 0.2, 1) infinite 1.6s;
    box-shadow: 0 0 30px var(--secondary-glow);
}

.ring-3 { 
    border: 2px solid var(--accent);
    animation: rippleModern 5s cubic-bezier(0.4, 0, 0.2, 1) infinite 3.2s;
    box-shadow: 0 0 30px var(--accent-glow);
}

@keyframes rippleModern { 
    0% { 
        width: 120px; 
        height: 120px; 
        opacity: 0.8; 
        border-width: 3px; 
    } 
    100% { 
        width: 600px; 
        height: 600px; 
        opacity: 0; 
        border-width: 0px; 
    } 
}

/* Botón PLAY rediseñado - Estilo glassmorphism */
.enter-btn { 
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
    width: 160px; 
    padding: 16px 0; 
    font-family: inherit;
    font-size: 0.875rem; 
    font-weight: 600; 
    letter-spacing: 3px; 
    cursor: pointer; 
    text-transform: uppercase; 
    border-radius: var(--radius-full);
    box-shadow: 
        0 8px 32px var(--primary-glow),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transition: all var(--transition-base);
    position: relative; 
    z-index: 20;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.enter-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s;
}

.enter-btn:hover::before {
    left: 100%;
}

.enter-btn:hover { 
    transform: translateY(-2px) scale(1.02);
    box-shadow: 
        0 12px 48px var(--primary-glow),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.enter-btn:active {
    transform: translateY(0px) scale(0.98);
}

/* Shortcuts typing - Rediseñado */
.shortcuts-typing {
    position: absolute;
    bottom: var(--space-2xl);
    left: 50%;
    transform: translateX(-50%);
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
    font-size: 0.75rem;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
    text-align: center;
    white-space: nowrap;
    min-height: 25px;
    font-weight: 400;
}

/* --- BARRA SUPERIOR (GLASSMORPHISM) --- */
/* 1. La barra gris se mantiene sólida y perfecta de lado a lado */
.marquee-container { 
    position: absolute; 
    top: 0; 
    left: 0;
    width: 100%; 
    height: 60px; 
    background: var(--bg-glass);
    border-bottom: 1px solid var(--border-subtle);
    z-index: 60; 
    overflow: hidden; 
    display: flex; 
    align-items: center; /* Ayuda al centrado base */
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
}

/* 2. La ventana que define dónde 'nace' el texto (antes de los botones) */
.marquee-viewport {
    position: absolute;
    top: 0;
    left: 0;
    /* Ajusta este valor (130px) si el texto sale muy lejos o muy cerca de la estrella */
    right: 130px; 
    height: 100%;
    overflow: hidden;
}

/* 3. Centrado vertical y corrección de texto cortado */
.marquee-content { 
    display: inline-block; 
    white-space: nowrap; 
    padding-left: 100%; 
    /* Agregamos un poco de espacio al final para que no se corte la última letra */
    padding-right: 50px; 
    animation: marquee 80s linear infinite;
    font-family: inherit;
    font-size: 1.06rem; 
    color: var(--text-secondary);
    text-transform: uppercase;
    font-weight: 500;
    letter-spacing: 1px;
    
    /* ESTO CORRIGE EL CENTRADO VERTICAL: debe ser igual a la altura de la barra */
    line-height: 60px; 
}

.marquee-content span { 
    color: var(--primary);
    font-weight: 600; 
    margin: 0 var(--space-sm);
}

@keyframes marquee { 
    0% { transform: translate(0, 0); } 
    100% { transform: translate(-100%, 0); } 
}

/* Botones superiores - Diseño moderno */
.top-buttons-group {
    position: absolute;
    top: 0;
    right: 0;
    display: flex;
    height: 60px;
    z-index: 65;
    transition: transform var(--transition-slow);
}

.fav-menu-btn-top, .qr-btn-top {
    height: 56px;
    background: transparent;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0 var(--space-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    border-left: 1px solid var(--border-subtle);
    font-size: 1.25rem;
    transition: all var(--transition-base);
    position: relative;
}

.fav-menu-btn-top::before,
.qr-btn-top::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: var(--primary);
    transform: scaleX(0);
    transition: transform var(--transition-base);
}

.fav-menu-btn-top:hover,
.qr-btn-top:hover {
    background: transparent !important;
    color: var(--primary);
}

.fav-menu-btn-top:hover::before,
.qr-btn-top:hover::before {
    transform: scaleX(1);
}

.qr-btn-top svg {
    fill: var(--text-secondary);
    width: 20px;
    height: 20px;
    transition: all var(--transition-base);
}

.qr-btn-top:hover svg {
    fill: var(--primary);
}

.top-buttons-group.minimized {
    transform: translateY(-100%);
}

.fav-menu-btn-top.minimized {
    transform: translateY(-100%);
    opacity: 0;
    pointer-events: none;
}

/* --- BADGE DE INFO (REDISEÑADO) --- */
.info-badge {
    position: absolute;
    top: -36px;
    left: 0;
    display: none;
    background: var(--primary);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.688rem;
    font-weight: 700;
    letter-spacing: 1.5px;
    padding: var(--space-sm) var(--space-md);
    width: fit-content;
    border-radius: var(--radius-sm);
    box-shadow: 0 4px 16px var(--primary-glow);
    text-transform: uppercase;
}

/* Badges de colores */
.badge-gold {
    background: var(--accent) !important;
    color: var(--bg-base) !important;
    box-shadow: 0 4px 16px var(--accent-glow);
}

.badge-pink {
    background: #ec4899 !important;
    color: var(--text-primary) !important;
    box-shadow: 0 4px 16px rgba(236, 72, 153, 0.4);
}

.badge-blue {
    background: var(--secondary) !important;
    color: var(--text-primary) !important;
    box-shadow: 0 4px 16px var(--secondary-glow);
}

/* --- PROMO CARD (DISEÑO CARD MODERNO) --- */
.promo-card {
    position: absolute; 
    bottom: 76px; 
    right: -420px;
    width: 380px; 
    height: 110px;
    background: var(--bg-glass);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    display: flex; 
    align-items: center;
    z-index: 80; 
    transition: right 0.8s var(--transition-slow);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    overflow: hidden;
}

.promo-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
}

.promo-card.show { 
    right: var(--space-lg); 
}

.promo-image { 
    width: 110px; 
    height: 100%; 
    object-fit: cover; 
    border-right: 1px solid var(--border-subtle);
}

.promo-content { 
    padding: var(--space-md) var(--space-lg); 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
}

.promo-title { 
    font-family: inherit;
    font-size: 0.75rem; 
    color: var(--primary);
    font-weight: 700; 
    text-transform: uppercase; 
    margin-bottom: var(--space-xs); 
    letter-spacing: 1.2px;
}

.promo-msg { 
    font-family: inherit;
    font-size: 0.813rem; 
    color: var(--text-secondary);
    line-height: 1.5; 
    font-weight: 400;
}

/* --- BARRA INFERIOR (CONTROL PANEL) --- */
.bottom-controls-bar {
    position: absolute; 
    bottom: 0; 
    left: 0; 
    width: 100%; 
    height: 60px; 
    background: var(--bg-glass);
    border-top: 1px solid var(--border-subtle);
    z-index: 60;
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    padding: 0 var(--space-lg); 
    box-sizing: border-box;
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    transition: transform var(--transition-slow);
}

.bottom-controls-bar .left-group,
.bottom-controls-bar .center-group,
.bottom-controls-bar .right-group {
    transition: all var(--transition-slow);
    transform: translateY(0);
    opacity: 1;
}

.bottom-controls-bar.minimized {
    transform: none !important;
}

.bottom-controls-bar.minimized .left-group,
.bottom-controls-bar.minimized .center-group,
.bottom-controls-bar.minimized .right-group {
    transform: translateY(150%);
    opacity: 0;
    pointer-events: none;
}

/* Grupo izquierdo */
.left-group { 
    display: flex; 
    align-items: center; 
    gap: var(--space-lg);
}

.interaction-container { 
    display: flex; 
    align-items: center; 
    gap: var(--space-md); 
    padding-right: var(--space-lg); 
    border-right: 1px solid var(--border-subtle);
}

.action-icon-btn { 
    display: flex; 
    align-items: center; 
    justify-content: center;
    width: 36px;
    height: 36px;
    cursor: pointer; 
    color: var(--text-secondary);
    transition: all var(--transition-base);
    font-size: 1.25rem; 
    line-height: 1;
    border-radius: var(--radius-sm);
    position: relative;
}

.action-icon-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--primary);
    opacity: 0;
    border-radius: var(--radius-sm);
    transition: opacity var(--transition-base);
}

.action-icon-btn:hover { 
    color: var(--primary);
}

.action-icon-btn:hover::before {
    opacity: 0.1;
}

.action-icon-btn.favorited { 
    color: var(--primary);
}

.action-icon-btn.favorited::before {
    opacity: 0.15;
}

@keyframes favoriteBounce {
    0% { transform: scale(1); }
    50% { transform: scale(1.25); }
    100% { transform: scale(1); }
}

.social-container { 
    display: flex; 
    align-items: center; 
    gap: var(--space-md);
}

.social-icon { 
    width: 18px; 
    height: 18px; 
    fill: var(--text-secondary);
    transition: all var(--transition-base);
    cursor: pointer;
}

.social-icon:hover { 
    fill: var(--primary);
    transform: scale(1.15);
}

/* Grupo central */
.center-group { 
    position: absolute; 
    left: 50%; 
    transform: translateX(-50%); 
    display: flex; 
    align-items: center; 
    gap: var(--space-lg); 
}

.playback-btn { 
    background: transparent; 
    border: none; 
    color: var(--text-secondary);
    font-size: 1.125rem; 
    cursor: pointer; 
    transition: all var(--transition-base);
    line-height: 1; 
    padding: var(--space-sm);
    border-radius: var(--radius-sm);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.playback-btn:hover { 
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.05);
}

.play-pause { 
    font-size: 1.5rem;
    width: 44px;
    height: 44px;
    background: var(--primary);
    color: var(--text-primary);
    border-radius: 50%;
}

.play-pause:hover {
    background: var(--primary-light);
    transform: scale(1.05);
}

/* Grupo derecho */
.right-group { 
    display: flex; 
    align-items: center; 
}

.volume-control { 
    display: flex; 
    align-items: center; 
    gap: var(--space-md); 
}

.vol-label { 
    font-size: 0.688rem; 
    color: var(--text-tertiary);
    font-weight: 600; 
    font-family: inherit;
    letter-spacing: 1px;
}

/* Slider rediseñado - Estilo moderno */
input[type=range] { 
    -webkit-appearance: none; 
    width: 90px; 
    height: 4px; 
    background: var(--bg-elevated-2);
    border-radius: var(--radius-full);
    outline: none; 
    transition: all var(--transition-base);
    position: relative;
}

input[type=range]:hover { 
    background: var(--bg-elevated-3);
}

input[type=range]::-webkit-slider-thumb { 
    -webkit-appearance: none; 
    width: 14px; 
    height: 14px; 
    background: var(--primary);
    cursor: pointer; 
    border-radius: 50%; 
    box-shadow: 0 2px 8px var(--primary-glow);
    transition: all var(--transition-base);
    border: 2px solid var(--text-primary);
}

input[type=range]::-webkit-slider-thumb:hover { 
    transform: scale(1.15);
    box-shadow: 0 4px 12px var(--primary-glow);
}

input[type=range]::-moz-range-thumb { 
    width: 14px; 
    height: 14px; 
    background: var(--primary);
    cursor: pointer; 
    border-radius: 50%; 
    box-shadow: 0 2px 8px var(--primary-glow);
    transition: all var(--transition-base);
    border: 2px solid var(--text-primary);
}

input[type=range]::-moz-range-thumb:hover { 
    transform: scale(1.15);
    box-shadow: 0 4px 12px var(--primary-glow);
}

/* --- MENÚ DE FAVORITOS (SIDEBAR DERECHO) --- */
#favorites-modal {
    position: absolute; 
    top: 57px; 
    right: 0; 
    width: 340px; 
    height: calc(100vh - 117px); 
    background: var(--bg-glass);
    border-left: 1px solid var(--border-default);
    z-index: 70; 
    transform: translateX(100%); 
    transition: transform var(--transition-slow);
    overflow-y: auto; 
    padding: var(--space-lg); 
    display: flex; 
    flex-direction: column;
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
}

#favorites-modal::-webkit-scrollbar {
    width: 6px;
}

#favorites-modal::-webkit-scrollbar-track {
    background: transparent;
}

#favorites-modal::-webkit-scrollbar-thumb {
    background: var(--border-default);
    border-radius: var(--radius-full);
}

#favorites-modal::-webkit-scrollbar-thumb:hover {
    background: var(--border-strong);
}

#favorites-modal.open { 
    transform: translateX(0); 
}

.fav-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-bottom: 1px solid var(--border-subtle);
    padding-bottom: var(--space-md); 
    margin-bottom: var(--space-lg); 
}

.fav-title { 
    color: var(--primary);
    font-family: inherit;
    font-size: 1rem;
    letter-spacing: 1px;
    font-weight: 700;
    text-transform: uppercase;
}

.play-all-btn { 
    background: var(--primary);
    color: var(--text-primary);
    border: none; 
    padding: var(--space-sm) var(--space-md); 
    font-size: 0.688rem; 
    font-weight: 700; 
    cursor: pointer; 
    text-transform: uppercase;
    font-family: inherit;
    letter-spacing: 1px;
    border-radius: var(--radius-sm);
    transition: all var(--transition-base);
    box-shadow: 0 2px 8px var(--primary-glow);
}

.play-all-btn:hover { 
    background: var(--primary-light);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px var(--primary-glow);
}

.play-all-btn:active {
    transform: translateY(0);
}

.fav-item { 
    display: flex; 
    flex-direction: column; 
    margin-bottom: var(--space-md); 
    cursor: pointer; 
    padding: var(--space-md); 
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
    background: var(--bg-elevated-1);
    position: relative;
    overflow: hidden;
}

.fav-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 3px;
    background: var(--primary);
    transform: scaleY(0);
    transition: transform var(--transition-base);
}

.fav-item:hover::before {
    transform: scaleY(1);
}

.fav-item:hover { 
    border-color: var(--primary);
    background: var(--bg-elevated-2);
    transform: translateX(-4px);
    box-shadow: var(--shadow-md);
}

.fav-item-title { 
    font-size: 0.875rem; 
    color: var(--text-primary);
    margin-bottom: var(--space-xs);
    font-family: inherit;
    font-weight: 600;
}

.fav-item-artist { 
    font-size: 0.75rem; 
    color: var(--text-secondary);
    font-family: inherit;
    font-weight: 400;
}

.no-favs { 
    color: var(--text-tertiary);
    font-size: 0.875rem; 
    font-style: italic; 
    text-align: center; 
    margin-top: var(--space-2xl); 
}

/* --- PANEL DE ESTADÍSTICAS --- */
#stats-panel {
    position: absolute;
    top: 90px;
    left: var(--space-lg);
    background: var(--bg-glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: 10px 20px;
    z-index: 80;
    width: 260px;
    font-family: inherit;
    box-shadow: var(--shadow-xl);
    transform: translateY(-20px);
    opacity: 0;
    pointer-events: none;
    transition: all var(--transition-slow);
}

#stats-panel.show {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
}

.stats-header {
    color: #00f2ff;
    font-family: inherit;
    font-size: 0.8rem;
    letter-spacing: 1px;
    margin-bottom: 6px;
    font-weight: 700;
    border-bottom: 1px solid var(--border-subtle);
    padding-bottom: 5px;
    text-transform: uppercase;
}

.stat-line {
    color: var(--text-primary);
    font-size: 0.85rem;
    margin-bottom: 3px;
    line-height: 1.2;
    font-weight: 400;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.stat-line .stat-icon {
    font-size: 1.125rem;
}

.stat-line .stat-value {
    color: var(--secondary);
    font-weight: 700;
    margin-left: auto;
}

.stats-artists {
    margin-top: 10px;
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
}

.stats-artists-title {
    color: var(--secondary);
    font-size: 0.75rem;
    font-weight: 700;
    margin-bottom: 2px;
    letter-spacing: 1px;
    text-transform: uppercase;
}

.stats-artist-item {
    color: var(--text-secondary);
    font-size: 0.75rem;
    margin-bottom: var(--space-sm);
    font-weight: 400;
    padding: var(--space-xs) 0;
}

.stats-artist-item .artist-name {
    color: var(--text-primary);
    font-weight: 600;
}

.stats-btn {
    flex: 1;
    background: transparent;
    border: 1px solid var(--border-default);
    color: var(--text-primary);
    padding: 8px;
    font-family: inherit;
    font-size: 0.75rem;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
    letter-spacing: 1px;
}

.stats-btn:hover {
    border-color: var(--secondary);
    background: rgba(20, 184, 166, 0.1);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

/* --- PANEL DE LOGROS (ACHIEVEMENTS) --- */
#achievements-panel {
    position: absolute;
    top: 76px;
    left: var(--space-lg);
    width: 340px;
    background: var(--bg-glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    z-index: 80;
    font-family: inherit;
    box-shadow: var(--shadow-xl);
    transform: translateY(-20px);
    opacity: 0;
    pointer-events: none;
    transition: all var(--transition-slow);
}

#achievements-panel.show {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
}

.ach-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border-subtle);
    padding-bottom: var(--space-md);
    margin-bottom: var(--space-lg);
}

.ach-title {
    color: var(--accent);
    font-family: inherit;
    font-size: 1rem;
    letter-spacing: 1px;
    font-weight: 700;
    text-transform: uppercase;
}

.ach-counter {
    color: var(--accent);
    font-family: inherit;
    font-size: 0.875rem;
    font-weight: 700;
}

.ach-page-container {
    min-height: auto;
    position: relative;
}

.ach-page {
    display: none;
}

.ach-page.active {
    display: block;
    }

@keyframes fadeInPage {
    from { opacity: 0; transform: translateX(12px); }
    to { opacity: 1; transform: translateX(0); }
}

.ach-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: var(--space-md);
    padding: var(--space-md);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    background: var(--bg-elevated-1);
    transition: all var(--transition-base);
    position: relative;
}

.ach-item.unlocked {
    border-color: var(--accent);
    background: rgba(245, 158, 11, 0.05);
}

.ach-item.unlocked::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 3px;
    background: var(--accent);
    border-radius: var(--radius-sm) 0 0 var(--radius-sm);
}

.ach-icon {
    font-size: 2rem;
    margin-right: var(--space-md);
    filter: grayscale(100%);
    opacity: 0.3;
    transition: all var(--transition-base);
    flex-shrink: 0;
}

.ach-item.unlocked .ach-icon {
    filter: grayscale(0%);
    opacity: 1;
    animation: achIconPulse 2s ease-in-out infinite alternate;
}

@keyframes achIconPulse {
    from { transform: scale(1); }
    to { transform: scale(1.08); }
}

.ach-content {
    flex: 1;
}

.ach-name {
    font-family: inherit;
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--text-tertiary);
    margin-bottom: var(--space-xs);
    letter-spacing: 0.5px;
    text-transform: uppercase;
}

.ach-item.unlocked .ach-name {
    color: var(--accent);
}

.ach-desc {
    font-family: inherit;
    font-size: 0.75rem;
    color: var(--text-secondary);
    line-height: 1.5;
    font-weight: 400;
}

.ach-item.unlocked .ach-desc {
    color: var(--text-secondary);
}

.ach-lock {
    font-size: 1rem;
    color: var(--text-disabled);
    margin-left: var(--space-sm);
    flex-shrink: 0;
}

.ach-item.unlocked .ach-lock {
    display: none;
}

.ach-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
}

.page-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--border-default);
    cursor: pointer;
    transition: all var(--transition-base);
}

.page-dot:hover {
    background: var(--border-strong);
    transform: scale(1.3);
}

.page-dot.active {
    background: var(--accent);
    width: 20px;
    border-radius: var(--radius-full);
    box-shadow: 0 0 8px var(--accent-glow);
}

/* --- NOTIFICACIÓN DE LOGRO (TOAST) --- */
#achievement-toast {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: var(--bg-glass);
    border: 2px solid var(--accent);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    z-index: 200;
    text-align: center;
    box-shadow: var(--shadow-xl);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    opacity: 0;
    transition: all var(--transition-bounce);
    min-width: 340px;
}

#achievement-toast.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
}

.toast-header {
    color: var(--accent);
    font-family: inherit;
    font-size: 1.125rem;
    letter-spacing: 2px;
    margin-bottom: var(--space-md);
    font-weight: 700;
    text-transform: uppercase;
}

.toast-icon {
    font-size: 4rem;
    margin: var(--space-md) 0;
    animation: toastIconBounce 0.6s var(--transition-bounce);
}

@keyframes toastIconBounce {
    0% { transform: scale(0) rotate(0deg); }
    50% { transform: scale(1.2) rotate(10deg); }
    100% { transform: scale(1) rotate(0deg); }
}

.toast-name {
    color: var(--accent);
    font-family: inherit;
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: 1px;
    margin: var(--space-md) 0 var(--space-sm) 0;
    text-transform: uppercase;
}

.toast-desc {
    color: var(--text-secondary);
    font-family: inherit;
    font-size: 0.938rem;
    font-weight: 400;
}

/* --- OVERLAY UI --- */
.overlay { 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    z-index: 10; 
    pointer-events: none; 
    display: none; 
}

.logo-watermark { 
    position: absolute; 
    top: 76px; 
    right: var(--space-lg); 
    opacity: 0.5;
    filter: drop-shadow(0 4px 16px var(--primary-glow));
}

.corner-logo { 
    width: 72px; 
    height: auto; 
    animation: logoFloat 4s ease-in-out infinite; 
}

/* --- TRACK INFO BOX (INFORMACIÓN DE CANCIÓN) --- */
.track-info { 
    position: absolute; 
    bottom: 90px; 
    left: var(--space-lg); 
    background: var(--bg-glass);
    padding: var(--space-md) var(--space-lg); 
    border-left: 4px solid var(--primary);
    border-radius: var(--radius-md);
    font-family: inherit;
    z-index: 10; 
    pointer-events: auto;
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    animation: slideInLeft 0.6s var(--transition-slow);
    display: inline-block;
    width: max-content; 
    max-width: 90vw;
    white-space: nowrap;
    box-shadow: var(--shadow-lg);
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.track-info h2 { 
    margin: 0; 
    font-size: 1.375rem; 
    text-transform: uppercase; 
    color: var(--text-primary);
    font-family: inherit;
    letter-spacing: 1px;
    font-weight: 700;
}

.track-info h3 { 
    margin: var(--space-sm) 0 0 0; 
    font-size: 1.063rem; 
    color: var(--primary);
    font-weight: 600; 
    font-family: inherit;
}

/* --- MODO LIMPIO (CLEAN MODE) --- */
body.clean-mode .marquee-container,
body.clean-mode .bottom-controls-bar,
body.clean-mode .vignette,
body.clean-mode .scanlines,
body.clean-mode .crt-effect,
body.clean-mode .overlay,
body.clean-mode .promo-card {
    opacity: 0 !important;
    pointer-events: none;
    transition: opacity 0.5s ease;
}

/* --- REWARDS SIDEBAR --- */
.rewards-sidebar {
    position: absolute;
    top: 0;
    right: 0; 
    width: 340px;
    height: 100%;
    background: var(--bg-glass);
    border-left: 1px solid var(--border-default);
    z-index: 9999;
    padding: var(--space-lg);
    display: flex;
    flex-direction: column;
    transform: translateX(100%); 
    transition: transform var(--transition-slow);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
}

.rewards-sidebar.active {
    transform: translateX(0); 
}

.rewards-header h3 {
    color: var(--primary);
    font-size: 1rem;
    margin-bottom: var(--space-md);
    letter-spacing: 1.5px;
    font-family: inherit;
    font-weight: 700;
    text-transform: uppercase;
}

.progress-bar-container {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-lg);
    font-family: inherit;
    font-weight: 500;
}

.progress-bar-bg {
    width: 100%; 
    height: 6px; 
    background: var(--bg-elevated-2);
    border-radius: var(--radius-full);
    margin-top: var(--space-sm);
    overflow: hidden;
}

.progress-bar-fill {
    height: 100%; 
    background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
    width: 0%; 
    transition: width 0.5s var(--transition-base);
    border-radius: var(--radius-full);
}

.rewards-list-vertical {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    overflow-y: auto; 
}

.rewards-list-vertical::-webkit-scrollbar {
    width: 6px;
}

.rewards-list-vertical::-webkit-scrollbar-track {
    background: transparent;
}

.rewards-list-vertical::-webkit-scrollbar-thumb {
    background: var(--border-default);
    border-radius: var(--radius-full);
}

.reward-item {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    background: var(--bg-elevated-1);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    transition: all var(--transition-base);
}

.reward-mini-cover {
    width: 90px; 
    height: 60px; 
    position: relative; 
    flex-shrink: 0;
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.reward-mini-cover img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
}

.reward-info { 
    display: flex; 
    flex-direction: column;
    flex: 1;
}

.r-title { 
    font-weight: 700; 
    font-size: 0.875rem; 
    color: var(--text-secondary);
    font-family: inherit;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.r-status { 
    font-size: 0.75rem; 
    color: var(--text-tertiary);
    margin-top: var(--space-xs); 
    font-family: inherit;
    font-weight: 500;
}

.reward-item.locked .reward-mini-cover img { 
    filter: grayscale(100%) brightness(0.4); 
}

.reward-item.locked { 
    cursor: not-allowed; 
    opacity: 0.6; 
}

.mini-lock {
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background: rgba(0,0,0,0.8);
    color: var(--primary);
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-size: 0.75rem; 
    font-weight: 700;
    font-family: inherit;
    backdrop-filter: blur(4px);
}

.reward-item.unlocked { 
    border-color: var(--secondary);
    cursor: pointer; 
}

.reward-item.unlocked:hover { 
    background: rgba(20, 184, 166, 0.08);
    transform: translateX(-4px); 
    box-shadow: var(--shadow-md);
}

.reward-item.unlocked .mini-lock { 
    display: none; 
}

.reward-item.unlocked .r-title { 
    color: var(--secondary);
}

.reward-item.unlocked .r-status { 
    color: var(--secondary);
}

.rewards-footer-mini {
    margin-top: auto; 
    padding-top: var(--space-lg);
    font-size: 0.75rem; 
    color: var(--text-tertiary);
    text-align: center;
    font-family: inherit;
}

/* --- MENSAJES DEL SISTEMA --- */
.sys-msg {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-glass);
    color: var(--secondary);
    font-family: inherit;
    font-size: 1rem;
    font-weight: 700;
    padding: var(--space-md) var(--space-xl);
    border: 1px solid var(--secondary);
    border-radius: var(--radius-md);
    z-index: 9999;
    box-shadow: var(--shadow-lg);
    pointer-events: none;
    transition: opacity 0.5s ease;
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
}

.hidden {
    opacity: 0;
    visibility: hidden;
}

.visible {
    opacity: 1;
    visibility: visible;
}

@keyframes unlockPulse {
    0% { 
        transform: scale(1); 
        box-shadow: 0 0 0 rgba(20, 184, 166, 0);
    }
    50% { 
        transform: scale(1.03); 
        box-shadow: 0 0 20px var(--secondary-glow);
    }
    100% { 
        transform: scale(1); 
        box-shadow: 0 0 0 rgba(20, 184, 166, 0);
    }
}

/* --- MENÚ DE COMPARTIR (SHARE MODAL) --- */
#share-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: var(--bg-glass);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    z-index: 9999;
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    box-shadow: var(--shadow-xl);
    opacity: 0;
    transition: all var(--transition-slow);
    min-width: 400px;
}

#share-modal.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
}

.share-header {
    color: var(--secondary);
    font-family: inherit;
    font-size: 1.25rem;
    letter-spacing: 2px;
    margin-bottom: var(--space-lg);
    text-align: center;
    font-weight: 700;
    border-bottom: 1px solid var(--border-subtle);
    padding-bottom: var(--space-md);
    text-transform: uppercase;
}

.share-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.share-btn {
    background: var(--bg-elevated-1);
    border: 1px solid var(--border-default);
    color: var(--text-primary);
    padding: var(--space-md);
    font-family: inherit;
    font-size: 0.813rem;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
    letter-spacing: 0.5px;
}

.share-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.share-btn.twitter { border-color: #1DA1F2; }
.share-btn.twitter:hover { 
    background: rgba(29, 161, 242, 0.1);
    border-color: #1DA1F2;
}

.share-btn.facebook { border-color: #4267B2; }
.share-btn.facebook:hover { 
    background: rgba(66, 103, 178, 0.1);
    border-color: #4267B2;
}

.share-btn.whatsapp { border-color: #25D366; }
.share-btn.whatsapp:hover { 
    background: rgba(37, 211, 102, 0.1);
    border-color: #25D366;
}

.share-btn.telegram { border-color: #0088cc; }
.share-btn.telegram:hover { 
    background: rgba(0, 136, 204, 0.1);
    border-color: #0088cc;
}

.share-btn.copy { border-color: var(--secondary); }
.share-btn.copy:hover { 
    background: rgba(20, 184, 166, 0.1);
    border-color: var(--secondary);
}

.share-close {
    background: transparent;
    border: 1px solid var(--primary);
    color: var(--primary);
    padding: var(--space-md) var(--space-lg);
    font-family: inherit;
    font-size: 0.813rem;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    border-radius: var(--radius-md);
    width: 100%;
    transition: all var(--transition-base);
    letter-spacing: 1px;
}

.share-close:hover {
    background: rgba(99, 102, 241, 0.1);
    transform: translateY(-2px);
}

/* --- MODAL DE LOGIN --- */
#login-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-overlay);
    backdrop-filter: blur(20px);
    z-index: 10000;
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 1;
    transition: opacity 0.5s ease;
}

#login-modal.hidden {
    opacity: 0;
    pointer-events: none;
}

.login-box {
    background: var(--bg-glass);
    border: 1px solid var(--border-default);
    border-radius: var(--radius-xl);
    padding: var(--space-2xl);
    text-align: center;
    box-shadow: var(--shadow-xl);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    min-width: 440px;
    max-width: 90vw;
}

.login-title {
    color: var(--primary);
    font-family: inherit;
    font-size: 2rem;
    letter-spacing: 2px;
    margin-bottom: var(--space-md);
    font-weight: 700;
}

.login-subtitle {
    color: var(--text-secondary);
    font-family: inherit;
    font-size: 0.938rem;
    margin-bottom: var(--space-xl);
    font-weight: 400;
}

.login-input {
    background: var(--bg-elevated-1);
    border: 1px solid var(--border-default);
    color: var(--text-primary);
    width: 100%;
    padding: var(--space-md);
    font-family: inherit;
    font-size: 1rem;
    outline: none;
    margin-bottom: var(--space-lg);
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
}

.login-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
    background: var(--bg-elevated-2);
}

.login-btn {
    background: var(--primary);
    border: none;
    color: var(--text-primary);
    width: 100%;
    padding: var(--space-md) 0;
    font-family: inherit;
    font-size: 0.938rem;
    font-weight: 700;
    letter-spacing: 1.5px;
    cursor: pointer;
    text-transform: uppercase;
    border-radius: var(--radius-md);
    box-shadow: 0 4px 12px var(--primary-glow);
    transition: all var(--transition-base);
}

.login-btn:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px var(--primary-glow);
}

.login-btn:active {
    transform: translateY(0);
}

.login-btn-secondary {
    background: transparent;
    border: 1px solid var(--secondary);
    color: var(--secondary);
    width: 100%;
    padding: var(--space-md) 0;
    font-family: inherit;
    font-size: 0.875rem;
    font-weight: 700;
    letter-spacing: 1.5px;
    cursor: pointer;
    text-transform: uppercase;
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
}

.login-btn-secondary:hover {
    background: rgba(20, 184, 166, 0.1);
    transform: translateY(-2px);
}

/* --- PIXEL BOARD MARQUEE --- */
.pixel-board-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 56px;
    background: var(--bg-glass);
    border-bottom: 1px solid var(--border-subtle);
    overflow: hidden;
    display: none;
    align-items: center;
    z-index: 60;
    pointer-events: none;
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
}

.marquee-text {
    white-space: nowrap;
    display: inline-block;
    font-size: 0.875rem;
    font-family: inherit;
    font-weight: 600;
    color: var(--primary);
    animation: marquee-animation 30s linear infinite;
    padding-left: 100%;
}

@keyframes marquee-animation {
    0% { transform: translateX(0); }
    100% { transform: translateX(-100%); }
}

/* --- CAPA DE ANIMACIONES (VOTOS) --- */
#animation-layer {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9999;
    overflow: hidden;
}

.vote-particle {
    position: absolute;
    bottom: -70px;
    font-size: 2rem;
    user-select: none;
    animation: flyUpAndWobble 4s linear forwards;
}

@keyframes flyUpAndWobble {
    0% {
        transform: translateY(0) translateX(0) rotate(0deg);
        opacity: 0;
    }
    10% { opacity: 1; }
    50% {
        transform: translateY(-50vh) translateX(40px) rotate(25deg);
    }
    100% {
        transform: translateY(-115vh) translateX(-40px) rotate(-25deg);
        opacity: 0;
    }
}

/* --- PANEL DE RANKING --- */
#ranking-panel {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    width: 280px;
    background: var(--bg-glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--accent);
    border-radius: var(--radius-xl);
    padding: 10px 15px;
    z-index: 200;
    font-family: inherit;
    box-shadow: var(--shadow-xl);
    opacity: 0;
    pointer-events: none;
    transition: all var(--transition-slow);
}

#ranking-panel.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
    pointer-events: auto;
}

.ranking-header {
    color: var(--accent);
    font-size: 0.9rem;
    text-align: center;
    margin-bottom: 5px;
    border-bottom: 1px solid var(--border-subtle);
    padding-bottom: 5px;
    letter-spacing: 1px;
    font-family: inherit;
    font-weight: 700;
    text-transform: uppercase;
}

.ranking-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2px 0;
    border-bottom: 1px solid var(--border-subtle);
}

.ranking-item:last-child {
    border-bottom: none;
}

.rank-number {
    color: var(--accent);
    font-size: 0.813rem;
    width: 32px;
    font-weight: 700;
}

.rank-info {
    flex: 1;
    overflow: hidden;
}

.rank-artist {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.8rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rank-votes {
    color: var(--secondary);
    font-size: 0.813rem;
    margin-left: var(--space-md);
    font-weight: 700;
}

.ranking-footer {
    margin-top: 5px;
    text-align: center;
    font-size: 0.688rem;
    color: var(--text-tertiary);
    font-family: inherit;
}

/* --- OVERLAY DE ENTRADA DE SEÑAL --- */
#signal-input-overlay {
    background: var(--bg-glass);
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    border: 1px solid var(--primary);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
}

#signal-input-field {
    background: var(--bg-elevated-1);
    border: 1px solid var(--border-default);
    color: var(--primary);
    border-radius: var(--radius-md);
    font-family: inherit;
}

#signal-input-field:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-glow);
    background: var(--bg-elevated-2);
}

/* --- QR OVERLAY --- */
#qr-overlay {
    background: rgba(15, 15, 15, 0.96);
    backdrop-filter: blur(20px);
}

/* --- RESPONSIVE DESIGN --- */
@media (max-width: 768px) {
    :root {
        --space-lg: 16px;
        --space-xl: 24px;
    }

    .track-info {
        left: var(--space-md);
        right: var(--space-md);
        max-width: calc(100% - 32px);
    }
    
    .track-info h2 {
        font-size: 1.125rem;
    }
    
    .track-info h3 {
        font-size: 0.938rem;
    }
    
    .promo-card {
        width: calc(100% - 32px);
        right: -100%;
    }
    
    .promo-card.show {
        right: var(--space-md);
    }

    #favorites-modal,
    .rewards-sidebar {
        width: 100%;
    }

    #stats-panel,
    #achievements-panel {
        width: calc(100% - 32px);
        left: var(--space-md);
        right: var(--space-md);
    }

    .login-box,
    #share-modal,
    #ranking-panel {
        min-width: auto;
        width: calc(100% - 32px);
    }
}

/* --- ACCESIBILIDAD Y MEJORAS --- */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Focus visible para accesibilidad */
*:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Mejora de rendimiento */
.tv-frame,
#player {
    will-change: transform;
}

</style>
</head>
<body>

    <div id="animation-layer"></div>
    <div id="start-screen">
        <div class="logo-container">
            <div class="ring ring-1"></div>
            <div class="ring ring-2"></div>
            <div class="ring ring-3"></div>
            <img src="logo.webp" alt="GMV Logo" class="start-logo">
        </div>

<div style="margin-bottom: 25px; font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(255,255,255,0.6); letter-spacing: 2px;">
    NETWORK_TRAFFIC: <span id="visit-count" style="color: white;">CONNECTING...</span>
</div>
<button class="enter-btn" onclick="startTV()">PLAY</button>
        
<div class="shortcuts-typing" id="shortcuts-typing"></div>
    </div>

<!-- LOGIN MODAL -->
<div id="login-modal" class="hidden">
    <div class="login-box">
        <div class="login-title">🎵 WELCOME TO GMV</div>
        <div class="login-subtitle">Enter your username to start watching</div>
        <input 
            type="text" 
            id="username-input" 
            class="login-input" 
            placeholder="Your username..." 
            maxlength="20"
            autocomplete="off"
        >
        <button class="login-btn" onclick="saveUsername()">START WATCHING</button>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255, 0, 85, 0.3);">
            <div style="color: #888; font-size: 0.75rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">
                Already have a backup?
            </div>
            <button class="login-btn-secondary" onclick="document.getElementById('import-file-login').click()">
                📥 LOAD BACKUP
            </button>
            <input type="file" id="import-file-login" accept=".gmv,.json" style="display: none;" onchange="importUserDataFromLogin(event)">
        </div>
    </div>
</div>

    <div class="tv-frame">
        <div id="player"></div>
	<div class="pixel-board-container">
    <div class="marquee-text" id="pixel-board-content">
        ⚠️[SYSTEM] > SIGNAL STABLE◼️◼️◼️[NETWORK] > STANDBY FOR INPUT◼️◼️◼️ /// [GMV] > PRESS 7 TO INJECT SIGNAL◼️◼️◼️⚠️
    </div>
</div>
        <div class="vignette"></div>
        <div class="scanlines"></div>
        <div class="crt-effect"></div>

<div class="marquee-container" id="tickerBar">
    <div class="marquee-viewport">
        <div class="marquee-content" id="newsTicker"></div>
    </div>

    <div class="top-buttons-group">
        <div class="qr-btn-top" onclick="toggleQRDesdeIcono()" title="Mostrar QR">
            <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zM13 3v8h8V3h-8zm6 6h-4V5h4v4zM13 13h2v2h-2v-2zm2 2h2v2h-2v-2zm2-2h2v2h-2v-2zm2 2h2v2h-2v-2zm-2 2h2v2h-2v-2zm0-4h2v2h-2v-2zm2 2h2v2h-2v-2zM13 15h2v2h-2v-2zm2 2h2v2h-2v-2zm0-4h2v2h-2v-2zm2 2h2v2h-2v-2z"/></svg>
        </div>
        <div class="fav-menu-btn-top" onclick="toggleFavMenu()">★</div>
    </div>
</div>

        <div id="promoCard" class="promo-card">
            <img src="" alt="Promo" id="promoImage" class="promo-image">
            <div class="promo-content">
                <div class="promo-title" id="promoTitle">TITLE</div>
                <div class="promo-msg" id="promoMsg">Message...</div>
            </div>
        </div>

        <div class="bottom-controls-bar" id="controlsBar" style="display:none;">
            <div class="left-group">
                <div class="interaction-container">
                    <div class="action-icon-btn" id="favBtn" onclick="toggleFavorite()" title="Save to Favorites">★</div>
                </div>
                <div class="social-container" id="topSocialLinks"></div>
            </div>
            <div class="center-group">
                <button class="playback-btn" onclick="previousChannel()" title="Previous">◄</button>
                <button class="playback-btn play-pause" onclick="togglePause()" id="playPauseBtn" title="Pause/Play">⏸</button>
                <button class="playback-btn" onclick="nextChannel()" title="Next">►</button>
            </div>
            <div class="right-group">
                <div class="volume-control">
                    <span class="vol-label">VOL</span>
                    <input type="range" id="volSlider" min="0" max="100" value="100" oninput="setVolume(this.value)">
                </div>
            </div>
        </div>

        <div id="favorites-modal">
            <div class="fav-header">
                <div class="fav-title">FAVORITES</div>
                <button class="play-all-btn" onclick="playAllFavorites()">PLAY ALL</button>
            </div>
            <div id="fav-list-content"></div>
        </div>

<div id="stats-panel">
    <div class="stats-header">📊 YOUR STATS</div>
    
    <div class="stat-line" style="border-bottom: 1px solid #333; padding-bottom: 12px; margin-bottom: 12px;">
        <span class="stat-icon">👤</span>User: <span class="stat-value" id="stat-username">LOADING...</span>
    </div>
    
    <div class="stat-line" style="border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 5px;">
        <span id="stat-level">🎵 Level 1 - Listener</span>
    </div>
    
    <div class="stat-line">
        <span class="stat-icon">🎵</span>Videos: <span class="stat-value" id="stat-videos">0</span>
    </div>
    <div class="stat-line">
        <span class="stat-icon">⏱️</span>Time: <span class="stat-value" id="stat-time">0h 0m</span>
    </div>
    <div class="stat-line">
        <span class="stat-icon">🔥</span>Streak: <span class="stat-value" id="stat-streak">0 days</span>
    </div>
<div class="stats-artists">
        <div class="stats-artists-title">🎤 TOP ARTISTS:</div>
        <div id="top-artists-list"></div>
    </div>
    
<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
        <button class="stats-btn" onclick="exportUserData()" title="Download backup" style="width: 100%;">
            💾 EXPORT DATA
        </button>
    </div>

</div> <div id="achievements-panel">
    <div class="ach-header">
        <div class="ach-title">🏆 ACHIEVEMENTS</div>
        <div class="ach-counter" id="ach-counter">0/10</div>
    </div>
    <div class="ach-page-container" id="ach-pages-container"></div>
    <div class="ach-pagination" id="ach-pagination"></div>
</div>

<!-- ACHIEVEMENT TOAST NOTIFICATION -->
<div id="achievement-toast">
    <div class="toast-header">🎉 ACHIEVEMENT UNLOCKED!</div>
    <div class="toast-icon" id="toast-icon">🏆</div>
    <div class="toast-name" id="toast-name">Achievement Name</div>
    <div class="toast-desc" id="toast-desc">Description</div>
</div>
        <div class="overlay" id="tvOverlay">
            <div class="logo-watermark">
                <img src="logo.webp" alt="GMV Logo" class="corner-logo">
            </div>
            
            <div class="track-info" id="trackInfoBox">
                <div id="dynamicBadge" class="info-badge"></div>
                <h2 id="songTitle">Loading...</h2>
                <h3 id="artistName">Please wait...</h3>
            </div>
        </div>

	<div id="ranking-panel">
    <div class="ranking-header">🌟 WEEKLY TOP 10</div>
    <div id="ranking-list-content">
        <div style="text-align:center; color:#555; font-size:0.8rem; padding:20px;">CONNECTING TO DATABASE...</div>
    </div>
    <div class="ranking-footer">PRESS [*] TO CLOSE</div>
</div>

    </div>
	<div id="rewardsSidebar" class="rewards-sidebar">
        
        <div class="rewards-header">
            <h3>/// CLASSIFIED ///</h3>
            <div class="progress-bar-container">
                <span id="monthlyProgress">0</span> / 100 VIEWS
                <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: 0%"></div></div>
            </div>
        </div>

        <div class="rewards-list-vertical">
            
            <div class="reward-item locked" id="reward-0">
                <div class="reward-mini-cover">
                    <img src="https://i.ytimg.com/vi/dQw4w9WgXcQ/hqdefault.jpg" alt="Secret 1">
                    <div class="mini-lock">🔒 50 REQ</div>
                </div>
                <div class="reward-info">
                    <span class="r-title">ARCHIVE_01</span>
                    <span class="r-status">LOCKED</span>
                </div>
            </div>

            <div class="reward-item locked" id="reward-1">
                <div class="reward-mini-cover">
                    <img src="img/rew2.webp" alt="Secret 2">
                    <div class="mini-lock">🔒 80 REQ</div>
                </div>
                <div class="reward-info">
                    <span class="r-title">ARCHIVE_02</span>
                    <span class="r-status">LOCKED</span>
                </div>
            </div>

            <div class="reward-item locked" id="reward-2">
                <div class="reward-mini-cover">
                    <img src="img/rew3.webp" alt="Secret 3">
                    <div class="mini-lock">🔒 120 REQ</div>
                </div>
                <div class="reward-info">
                    <span class="r-title">ARCHIVE_03</span>
                    <span class="r-status">LOCKED</span>
                </div>
            </div>

        </div>
        
        <div class="rewards-footer-mini">PRESS [9] TO CLOSE</div>
<div class="pixel-board-container">
        <div class="marquee-text" id="pixel-board-content">
            /// [SYSTEM] > SIGNAL STABLE◼️◼️◼️ /// [GMV] > READY FOR INPUT◼️◼️◼️ ///
        </div>
    </div>
    </div>
    
<script src="playlist.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <script>
        // 1. Iniciamos la conexión y sala una sola vez
        const socket = io('https://gmv-server.onrender.com');
        const myRoom = "GMV-" + Math.random().toString(36).substring(2, 6).toUpperCase();

        // 2. Esperar a que se carguen los videos antes de iniciar
        let checkVideosInterval = setInterval(() => {
            if (typeof musicVideos !== 'undefined' && musicVideos.length > 0) {
                clearInterval(checkVideosInterval);
                console.log("✅ Videos listos, sistema iniciado");
            }
        }, 100);
    </script>

    <script src="news.js"></script>
    <script src="promos.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <script>
 
// === SISTEMA DE AUTENTICACIÃ"N DE ARTISTAS ===
const artistRegistry = {
    "nexo001": { name: "N E X O", type: "artist" },
    "clave3": { name: "TRAVIS SCOTT", type: "artist" },
    // Agrega más artistas aquí con sus claves secretas
};

const adminKey = "edgar";

// Variable global para almacenar el artista autenticado
let authenticatedArtist = null;

// Al cargar la página, verificar si hay un artista guardado
function loadArtistAuth() {
    const saved = localStorage.getItem('gmv_artist_auth');
    if (saved) {
        authenticatedArtist = saved;
        console.log("🎨 Artist session restored:", authenticatedArtist);
    }
}

// Guardar artista autenticado
function saveArtistAuth(artistName, type) {
    authenticatedArtist = { name: artistName, type: type };
    localStorage.setItem('gmv_artist_auth', JSON.stringify({ name: artistName, type: type }));
    console.log("Authenticated:", artistName, "Type:", type);
}

    let totalViewsForRewards = 0;
	let isInputActive = false; // Bandera para saber si el overlay del muro está activo

	// --- FUNCIONES DEL MENÚ REWARDS ---
function updateRewardsUI() {
        // 1. DECIDIR LA META ACTUAL
        let currentGoal = 50;
        if (totalViewsForRewards >= 50) currentGoal = 80;
        if (totalViewsForRewards >= 80) currentGoal = 120;

        // 2. Calcular porcentaje
        const percentage = Math.min((totalViewsForRewards / currentGoal) * 100, 100);
        
        // 3. ACTUALIZAR BARRA
        const container = document.querySelector('.progress-bar-container');
        if (container) {
            container.innerHTML = `
                <span id="monthlyProgress">${totalViewsForRewards}</span> / ${currentGoal} VIEWS
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" style="width: ${percentage}%"></div>
                </div>
            `;
        }

        // 4. REVISAR CANDADOS
        secretRewards.forEach((reward, index) => {
            const card = document.getElementById('reward-' + index);
            if(!card) return;

            const titleEl = card.querySelector('.r-title'); 
            const statusEl = card.querySelector('.r-status'); 

            if (totalViewsForRewards >= reward.req) {
                // --- DESBLOQUEADO ---
                card.classList.remove('locked');
                card.classList.add('unlocked');
                
		// ✨ Animación de desbloqueo (solo si es la primera vez)
    if (!card.dataset.wasUnlocked) {
        card.style.animation = 'unlockPulse 0.6s ease';
        setTimeout(() => card.style.animation = '', 600);
        card.dataset.wasUnlocked = 'true';
    }

                // Texto bonito en el menú
                titleEl.innerHTML = `
                    <span style="color: #fff; font-size: 1rem;">🔓 ${reward.realArtist}</span><br>
                    <span style="color: #FFD700; font-size: 0.85rem; letter-spacing: 1px;">${reward.realTitle}</span>
                `;
                titleEl.style.textShadow = "none";
                statusEl.innerText = "CLICK TO WATCH";
                statusEl.style.color = "#00ffaa"; 

                // --- ¡AQUÍ ESTÁ EL CAMBIO IMPORTANTE! ---
                card.onclick = function() { 
                    // 1. Preparamos los datos para la pantalla principal
                    const rewardVideo = {
                        id: reward.id,
                        artist: reward.realArtist,   // <--- Aquí mandamos el Artista Real
                        title: reward.realTitle,     // <--- Aquí mandamos el Título Real
                        badgeText: "SECRET UNLOCKED",// <--- Le ponemos una etiqueta especial
                        badgeColor: "gold"
                    };

                    // 2. Usamos la función maestra que actualiza TODO (video y textos)
                    playSpecificVideo(rewardVideo, false); 
                    
                    // 3. Cerramos el menú
                    toggleRewardsSidebar(); 
                };
            } else {
                // --- BLOQUEADO ---
                card.classList.add('locked');
                card.classList.remove('unlocked');
                
                titleEl.innerHTML = reward.title; 
                titleEl.style.color = "#ccc"; 
                statusEl.innerText = "LOCKED";
                statusEl.style.color = "#666";
                card.onclick = null; 
            }
        });
    }

    function toggleRewardsSidebar() {
        const sidebar = document.getElementById('rewardsSidebar');
        if(!sidebar) return;
        
        sidebar.classList.toggle('active');
        
        // Si se abre, actualizamos los datos al instante
        if (sidebar.classList.contains('active')) {
            updateRewardsUI();
        }
    }

// --- SWITCH DE MARQUESINAS (TECLA 8) ---
let showingChat = false; // false = mostrando news, true = mostrando chat

function toggleMarqueeContent() {
    const chatBoard = document.querySelector('.pixel-board-container');
    const newsBar = document.querySelector('.marquee-container');
    
    if (!chatBoard || !newsBar) return;
    
    if (!showingChat) {
        // Mostrar CHAT, ocultar NEWS
        newsBar.style.display = 'none';
        chatBoard.style.display = 'flex';
        showingChat = true;
    } else {
        // Mostrar NEWS, ocultar CHAT
        chatBoard.style.display = 'none';
        newsBar.style.display = 'flex';
        showingChat = false;
    }
}

document.addEventListener('keydown', function(e) {
    if (isInputActive) return;
    if (e.key === '8') {
        toggleMarqueeContent();
    }
});

    // --- ESCUCHAR LA TECLA 9 ---
    document.addEventListener('keydown', function(e) {
        if (isInputActive) return;
	if (e.key === '9') {
            toggleRewardsSidebar();
        }
    
	if (e.key === '+') {
        triggerVoteAnimation('up');
        injectVoteToSheet('up');
    }

	// Tecla "-" para voto negativo
        if (e.key === '-') {
            triggerVoteAnimation('down');
            injectVoteToSheet('down');
        }

	// Tecla "*" para abrir/cerrar el TOP 10
        if (e.key === '*' || e.key === 'Multiply') {
            toggleRanking();
        }
});
 
// 🎯 FUNCIÓN PARA CERRAR EL OVERLAY (reutilizable)
function closeSignalOverlay() {
    const overlayMuro = document.getElementById('signal-input-overlay');
    const fieldMuro = document.getElementById('signal-input-field');
    
    if (fieldMuro) fieldMuro.value = "";
    if (overlayMuro) {
        overlayMuro.classList.remove('visible');
        overlayMuro.classList.add('hidden');
    }
    isInputActive = false;
}

// 🎯 FUNCIÓN PARA ENVIAR EL MENSAJE
function sendSignalToWall(mensaje) {
    const board = document.getElementById('pixel-board-content');
    
    let formDataMessage;
    
    if (authenticatedArtist) {
        formDataMessage = `[${authenticatedArtist.name}] ${mensaje}`;
    } else {
        formDataMessage = mensaje;
    }
    
    // Envío al Google Form
    const formURL = "https://docs.google.com/forms/d/e/1FAIpQLSepKGRYPelGXeSBL7icVYp-zB5QVSXipHD2qsxV-FsDze9hEw/formResponse";
    const formData = new FormData();
    formData.append("entry.1682995054", formDataMessage);
    fetch(formURL, { method: "POST", mode: "no-cors", body: formData });
    
    // Agregar al muro con el color correspondiente
    if (board) {
        const pressText = '<span style="color: #fff;">PRESS 7 TO INJECT SIGNAL</span> <span style="color: #666;">:</span> ';
        const currentContent = board.innerHTML;
        const messagesOnly = currentContent.replace(pressText, '').replace('<span style="color: #555;">NO SIGNALS DETECTED</span>', '');
        
        if (authenticatedArtist) {
            const color = authenticatedArtist.type === 'admin' ? '#FFD700' : '#00f2ff';
            board.innerHTML = pressText + `<span style="color: ${color};">[${authenticatedArtist.name}] ${mensaje}</span> <span style="color: #666;">●</span> ` + messagesOnly;
        } else {
            board.innerHTML = pressText + '<span style="color: #fff;">[SIGNAL]</span> <span style="color: #ff0055;"> ' + formDataMessage + '</span> <span style="color: #666;">●</span> ' + messagesOnly;
        }
    }
    
    showSystemMessage("SIGNAL INJECTED: SUCCESS");
    setTimeout(() => loadMessagesFromSheet(), 1000);
}

// 🎯 FUNCIÓN PARA CARGAR MENSAJES DESDE GOOGLE SHEETS
function loadMessagesFromSheet() {
    console.log("🔄 Intentando cargar mensajes del CSV...");
    
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSrBDDpK_Th8p2zl_uO1T20ojNV59hUFfkdi4JVq8dYoGFNuOO3-d8K0KHGk0aPcXhJEOutURUIBW5h/pub?gid=579607902&single=true&output=csv";
    
    fetch(CSV_URL)
        .then(response => {
            console.log("✅ Respuesta recibida del CSV");
            return response.text();
        })
        .then(csvText => {
            console.log("📄 CSV completo:", csvText);
            
            const lines = csvText.trim().split('\n');
            console.log("📊 Número de líneas:", lines.length);
            
            const messages = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    console.log("Procesando línea", i, ":", line);
                    
                    const columns = line.split(',');
                    
                    if (columns.length >= 2) {
                        let mensaje = columns[1];
                        mensaje = mensaje.replace(/^["']|["']$/g, '').trim();
                        
                        console.log("Mensaje extraído:", mensaje);
                        if (mensaje) {
                            messages.push(mensaje);
                        }
                    }
                }
            }
            
            console.log("💬 Total de mensajes:", messages.length);
            console.log("📝 Mensajes:", messages);
            
            const board = document.getElementById('pixel-board-content');
            if (board) {
                if (messages.length > 0) {
                    const recentMessages = messages.slice(-10).reverse();
                    
		const wallText = recentMessages
    .map(msg => {
        // Detectar si es mensaje de GMV (admin)
        if (msg.includes('[GMV]')) {
            return `<span style="color: #FFD700;">${msg}</span>`;
        }
        // Detectar si es mensaje de artista verificado (contiene [NOMBRE])
        else if (msg.startsWith('[') && msg.includes(']') && !msg.includes('[SIGNAL]')) {
            return `<span style="color: #00f2ff;">${msg}</span>`;
        }
        // Mensaje de usuario normal
        else {
            return `<span style="color: #fff;">[SIGNAL]</span> <span style="color: #ff0055;"> ${msg}</span>`;
        }
    })
    .join(' <span style="color: #666;">●</span> ');
                    
                    board.innerHTML = '<span style="color: #fff;">PRESS 7 TO INJECT SIGNAL</span> <span style="color: #666;">:</span> ' + wallText;	
                    
                    console.log("✅ Muro actualizado con", recentMessages.length, "mensajes");
                } else {
                    console.log("⚠️ No hay mensajes, manteniendo texto por defecto");
                    board.innerHTML = '<span style="color: #fff;">PRESS 7 TO INJECT SIGNAL</span> <span style="color: #666;">:</span> <span style="color: #555;">NO SIGNALS DETECTED</span>';
                }
            } else {
                console.log("❌ El elemento pixel-board-content no existe");
            }
        })
        .catch(error => {
            console.error('❌ Error al cargar mensajes:', error);
        });
}


// --- CONTROL DEL MURO (TECLA 7) ---
document.addEventListener('keydown', function(e) {
    if (isInputActive && e.key !== '7' && e.key !== 'Escape') return;
    
if (e.key === '7') {
        // Si NO está activo, lo abrimos
        if (!isInputActive) {
            const overlayMuro = document.getElementById('signal-input-overlay');
            const fieldMuro = document.getElementById('signal-input-field');

            if (overlayMuro && fieldMuro) {
                overlayMuro.classList.remove('hidden');
                overlayMuro.classList.add('visible');
                fieldMuro.value = ""; 
                isInputActive = true;
                
                setTimeout(() => {
                    fieldMuro.focus();
                    
                    // Listener interno para procesar teclado dentro del cuadro
                    fieldMuro.onkeydown = function(event) {
                        event.stopPropagation(); // Evita que las letras activen otros comandos de la TV
                        
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            const texto = this.value.trim();
                            if (texto !== "") sendSignalToWall(texto.toUpperCase());
                            closeSignalOverlay();
                        }
                        
                        if (event.key === 'Escape') {
                            event.preventDefault();
                            closeSignalOverlay();
                        }
                    };
                }, 50);
            }
        } 
        // Si YA está activo, lo cerramos
        else {
            closeSignalOverlay();
        }
    }
});



        var player;
        var videoCount = 0;
	var viewTimer = null; // Guardará el temporizador
        const MIN_WATCH_TIME = 60000; // 60 segundos (en milisegundos)
        var isCommercial = false;
        var playerReady = false;
        var currentVideo = null; 
        var historyStack = [];
        var isGoingBack = false;
        var promoInterval;
	var nextCommercialTarget = Math.floor(Math.random() * 3) + 3; // Define el primer comercial entre el video 3 y 5
// --- STATS SYSTEM ---
var statsData = {
    totalVideos: 0,
    monthlyVideos: 0,
    totalMinutes: 0,
    currentStreak: 0,
    longestStreak: 0,
    lastVisit: null,
    lastMonth: null,
    artistCounts: {},
    sessionStart: null,
    permanentAchievements: 0,
    lastAchievementMonth: null
};

function loadStats() {
    const saved = localStorage.getItem('gmv_stats');
    if (saved) {
        statsData = JSON.parse(saved);
    }
    updateStreakOnLoad();
// --- AGREGA ESTO AQUÍ: Sincronizar Rewards con Stats ---
    totalViewsForRewards = statsData.totalVideos; 
    updateRewardsUI();
}

function saveStats() {
    localStorage.setItem('gmv_stats', JSON.stringify(statsData));
}

function updateStreakOnLoad() {
    const today = new Date().toISOString().split('T')[0];
    const lastVisit = statsData.lastVisit;
 
    // --- NUEVO: Detectar cambio de mes ---
    const currentMonth = new Date().toISOString().slice(0, 7); // "2025-01"
    const lastMonth = statsData.lastMonth || currentMonth;
    const lastAchMonth = statsData.lastAchievementMonth || currentMonth;
    
    if (currentMonth !== lastMonth) {
        // ¡NUEVO MES! Reiniciamos contador mensual
        statsData.monthlyVideos = 0;
        statsData.lastMonth = currentMonth;
        console.log("🗓️ New month detected. Monthly counter reset to 0.");
    }
    
    // Resetear logros mensuales si cambió el mes
    if (currentMonth !== lastAchMonth) {
        localStorage.removeItem('gmv_achievements');
        statsData.lastAchievementMonth = currentMonth;
        console.log("🏆 New month detected. Monthly achievements reset.");
    }
    // --- FIN NUEVO ---
   
    if (!lastVisit) {
        statsData.currentStreak = 1;
        statsData.longestStreak = 1;
        statsData.lastVisit = today;
        saveStats();
        return;
    }
    
    if (lastVisit === today) {
        return;
    }
    
    const last = new Date(lastVisit);
    const now = new Date(today);
    const diffTime = Math.abs(now - last);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) {
        statsData.currentStreak++;
        if (statsData.currentStreak > statsData.longestStreak) {
            statsData.longestStreak = statsData.currentStreak;
        }
    } else {
        statsData.currentStreak = 1;
    }
    
    statsData.lastVisit = today;
    saveStats();
}

function trackVideoView(video) {
    if (!video || isCommercial) return;
    
    statsData.totalVideos++;
    statsData.monthlyVideos++;
    
    if (!statsData.artistCounts[video.artist]) {
        statsData.artistCounts[video.artist] = 0;
    }
    statsData.artistCounts[video.artist]++;
    
    saveStats();
}

function trackWatchTime() {
    if (!statsData.sessionStart) {
        statsData.sessionStart = Date.now();
    }
}

function updateWatchTime() {
    if (statsData.sessionStart && player && player.getPlayerState) {
        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
            const elapsed = Math.floor((Date.now() - statsData.sessionStart) / 60000);
            if (elapsed > 0) {
                statsData.totalMinutes += elapsed;
                statsData.sessionStart = Date.now();
                saveStats();
            }
        }
    }
}

function toggleStatsPanel() {
    const panel = document.getElementById('stats-panel');
    const achPanel = document.getElementById('achievements-panel');
    
    // Cerrar achievements si está abierto
    if (achPanel.classList.contains('show')) {
        achPanel.classList.remove('show');
    }
    
    panel.classList.toggle('show');
    
    if (panel.classList.contains('show')) {
        renderStats();
    }
}

function renderStats() {
    // Mostrar username
    const username = localStorage.getItem('gmv_username') || 'GUEST';
    document.getElementById('stat-username').innerText = username.toUpperCase();
    
    // Calcular nivel basado en logros PERMANENTES
    const levelInfo = calculateLevel(statsData.permanentAchievements);
    document.getElementById('stat-level').innerHTML = `${levelInfo.icon} ${levelInfo.title}`;
    
    document.getElementById('stat-videos').innerText = statsData.totalVideos;
    
    const hours = Math.floor(statsData.totalMinutes / 60);
    const mins = statsData.totalMinutes % 60;
    document.getElementById('stat-time').innerText = `${hours}h ${mins}m`;
    
    document.getElementById('stat-streak').innerText = `${statsData.currentStreak} days`;
    
    const sorted = Object.entries(statsData.artistCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
    
    const artistList = document.getElementById('top-artists-list');
    if (sorted.length === 0) {
        artistList.innerHTML = '<div class="stats-artist-item" style="color:#555;">No data yet</div>';
    } else {
        artistList.innerHTML = sorted.map((item, i) => 
            `<div class="stats-artist-item">${i + 1}. <span class="artist-name">${item[0]}</span> (${item[1]})</div>`
        ).join('');
    }
}

function calculateLevel(achievementCount) {
    if (achievementCount >= 120) return { icon: '🌟', title: 'Level 10 - GMV Legend' };
    if (achievementCount >= 100) return { icon: '🏆', title: 'Level 9 - Master' };
    if (achievementCount >= 80) return { icon: '👑', title: 'Level 8 - Champion' };
    if (achievementCount >= 70) return { icon: '⭐', title: 'Level 7 - Devotee' };
    if (achievementCount >= 60) return { icon: '🎧', title: 'Level 6 - Addict' };
    if (achievementCount >= 50) return { icon: '🔥', title: 'Level 5 - Collector' };
    if (achievementCount >= 40) return { icon: '🎤', title: 'Level 4 - Curator' };
    if (achievementCount >= 30) return { icon: '🎸', title: 'Level 3 - Fan' };
    if (achievementCount >= 20) return { icon: '🎶', title: 'Level 2 - Explorer' };
    if (achievementCount >= 10) return { icon: '🎵', title: 'Level 1 - Listener' };
    return { icon: '', title: 'Level 0 - Newbie' };
}

// --- EXPORT/IMPORT SYSTEM ---
function exportUserData() {
    const exportData = {
        version: '1.1',
        exportDate: new Date().toISOString(),
        username: localStorage.getItem('gmv_username'),
        stats: statsData,
        achievements: JSON.parse(localStorage.getItem('gmv_achievements') || '{}'),
        favorites: JSON.parse(localStorage.getItem('gmv_favorites') || '[]'),
        artistAuth: localStorage.getItem('gmv_artist_auth'),
        permanentAchievements: statsData.permanentAchievements
    };
    
    // Convertir a JSON y codificar en Base64
    const jsonString = JSON.stringify(exportData);
    const encoded = btoa(unescape(encodeURIComponent(jsonString)));
    
    // Crear archivo para descargar
    const blob = new Blob([encoded], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `GMV_Backup_${exportData.username}_${Date.now()}.gmv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showSystemMessage('💾 DATA EXPORTED SUCCESSFULLY');
}

function importUserData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            // Decodificar Base64 y parsear JSON
            const encoded = e.target.result;
            const jsonString = decodeURIComponent(escape(atob(encoded)));
            const importData = JSON.parse(jsonString);
            
            // Validar versión
            if (!importData.version || !importData.username) {
                showSystemMessage('❌ INVALID BACKUP FILE');
                return;
            }
            
            // Confirmar restauración
            if (!confirm(`Restore backup for user "${importData.username}"?\n\nThis will overwrite your current data.`)) {
                return;
            }
            
            // Restaurar datos
            localStorage.setItem('gmv_username', importData.username);
            localStorage.setItem('gmv_stats', JSON.stringify(importData.stats));
            localStorage.setItem('gmv_achievements', JSON.stringify(importData.achievements));
            localStorage.setItem('gmv_favorites', JSON.stringify(importData.favorites));
            if (importData.artistAuth) {
                localStorage.setItem('gmv_artist_auth', importData.artistAuth);
            }
            
            // Recargar stats
            loadStats();
            renderStats();
            
            showSystemMessage('✅ DATA RESTORED: ' + importData.username.toUpperCase());
            
            // Recargar página después de 2 segundos
            setTimeout(() => {
                location.reload();
            }, 2000);
            
        } catch (error) {
            console.error('Import error:', error);
            showSystemMessage('❌ IMPORT FAILED - CORRUPTED FILE');
        }
    };
    reader.readAsText(file);
    
    // Resetear input para permitir importar el mismo archivo de nuevo
    event.target.value = '';
}

function importUserDataFromLogin(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            // Decodificar Base64 y parsear JSON
            const encoded = e.target.result;
            const jsonString = decodeURIComponent(escape(atob(encoded)));
            const importData = JSON.parse(jsonString);
            
            // Validar versión
            if (!importData.version || !importData.username) {
                showSystemMessage('❌ INVALID BACKUP FILE');
                return;
            }
            
            // Restaurar datos (incluyendo logros permanentes)
            localStorage.setItem('gmv_username', importData.username);
            
            // Asegurar que permanentAchievements esté en stats
            if (importData.permanentAchievements !== undefined) {
                importData.stats.permanentAchievements = importData.permanentAchievements;
            }
            
            localStorage.setItem('gmv_stats', JSON.stringify(importData.stats));
            localStorage.setItem('gmv_achievements', JSON.stringify(importData.achievements));
            localStorage.setItem('gmv_favorites', JSON.stringify(importData.favorites));
            if (importData.artistAuth) {
                localStorage.setItem('gmv_artist_auth', importData.artistAuth);
            }
            
            // Ocultar modal de login
            document.getElementById('login-modal').classList.add('hidden');
            
            // Recargar stats
            loadStats();
            
            showSystemMessage('✅ BACKUP LOADED: ' + importData.username.toUpperCase());
            
            // Iniciar TV automáticamente después de 1.5 segundos
            setTimeout(() => {
                if (playerReady) {
                    var elem = document.documentElement;
                    if (elem.requestFullscreen) { 
                        elem.requestFullscreen().catch(err => console.log(err)); 
                    } else if (elem.webkitRequestFullscreen) { 
                        elem.webkitRequestFullscreen(); 
                    }

                    const screen = document.getElementById('start-screen');
                    screen.style.opacity = '0';
                    setTimeout(() => { 
                        screen.style.display = 'none'; 
                    }, 800);
                    
                    document.getElementById('tvOverlay').style.display = 'block';
                    document.getElementById('controlsBar').style.display = 'flex'; 
                    playNextVideo();
                    startPromoCycle();
                }
            }, 1500);
            
        } catch (error) {
            console.error('Import error:', error);
            showSystemMessage('❌ IMPORT FAILED - CORRUPTED FILE');
        }
    };
    reader.readAsText(file);
    
    // Resetear input
    event.target.value = '';
}

// Inicializar stats al cargar
loadStats();
trackWatchTime();

// Actualizar tiempo cada minuto
setInterval(updateWatchTime, 60000);
	// --- ACHIEVEMENTS SYSTEM ---
const achievementsList = [
    {
        id: 'first_step',
        icon: '🎬',
        name: 'First Step',
        desc: 'Watch your first video',
        check: () => statsData.totalVideos >= 1
    },
    {
        id: 'collector',
        icon: '❤️',
        name: 'Collector',
        desc: 'Save your first favorite',
        check: () => {
            const favs = JSON.parse(localStorage.getItem('gmv_favorites') || '[]');
            return favs.length >= 1;
        }
    },
    {
        id: 'music_lover',
        icon: '🎤',
        name: 'Music Lover',
        desc: 'Watch 10 videos',
        check: () => statsData.totalVideos >= 10
    },
    {
        id: 'binge_watcher',
        icon: '📺',
        name: 'Binge Watcher',
        desc: 'Watch 25 videos',
        check: () => statsData.totalVideos >= 25
    },
    {
        id: 'explorer',
        icon: '🗺️',
        name: 'Explorer',
        desc: 'Discover 10 different artists',
        check: () => Object.keys(statsData.artistCounts).length >= 10
    },
    {
        id: 'curator',
        icon: '💎',
        name: 'Curator',
        desc: 'Save 10 favorites',
        check: () => {
            const favs = JSON.parse(localStorage.getItem('gmv_favorites') || '[]');
            return favs.length >= 10;
        }
    },
    {
        id: 'week_warrior',
        icon: '🔥',
        name: 'Week Warrior',
        desc: '7 day viewing streak',
        check: () => statsData.currentStreak >= 7
    },
    {
        id: 'night_owl',
        icon: '🌙',
        name: 'Night Owl',
        desc: 'Watch a video after midnight',
        check: () => {
            const achievements = JSON.parse(localStorage.getItem('gmv_achievements') || '{}');
            return achievements.night_owl || false;
        }
    },
    {
        id: 'early_bird',
        icon: '🐦',
        name: 'Early Bird',
        desc: "Watch a 'Just Dropped' video",
        check: () => {
            const achievements = JSON.parse(localStorage.getItem('gmv_achievements') || '{}');
            return achievements.early_bird || false;
        }
    },
    {
        id: 'gmv_legend',
        icon: '👑',
        name: 'GMV Legend',
        desc: 'Unlock all achievements',
        check: () => {
            const achievements = JSON.parse(localStorage.getItem('gmv_achievements') || '{}');
            const unlockedCount = achievementsList.filter(ach => 
                ach.id === 'gmv_legend' ? false : (achievements[ach.id] || ach.check())
            ).length;
            return unlockedCount >= 9;
        }
    }
];

let currentAchPage = 0;
const ACHIEVEMENTS_PER_PAGE = 3;

function checkAchievements() {
    let achievements = JSON.parse(localStorage.getItem('gmv_achievements') || '{}');
    let newUnlocks = [];
    
    achievementsList.forEach(ach => {
        if (!achievements[ach.id] && ach.check()) {
            achievements[ach.id] = {
                unlocked: true,
                timestamp: Date.now()
            };
            newUnlocks.push(ach);
            
            // Sumar al contador permanente
            statsData.permanentAchievements++;
            saveStats();
        }
    });
    
    localStorage.setItem('gmv_achievements', JSON.stringify(achievements));
    
    newUnlocks.forEach(ach => showAchievementToast(ach));
}

function checkNightOwl() {
    const hour = new Date().getHours();
    if (hour >= 0 && hour < 6) {
        let achievements = JSON.parse(localStorage.getItem('gmv_achievements') || '{}');
        if (!achievements.night_owl) {
            achievements.night_owl = { unlocked: true, timestamp: Date.now() };
            localStorage.setItem('gmv_achievements', JSON.stringify(achievements));
            checkAchievements();
        }
    }
}

function checkEarlyBird(video) {
    if (video && video.badgeText === 'JUST DROPPED') {
        let achievements = JSON.parse(localStorage.getItem('gmv_achievements') || '{}');
        if (!achievements.early_bird) {
            achievements.early_bird = { unlocked: true, timestamp: Date.now() };
            localStorage.setItem('gmv_achievements', JSON.stringify(achievements));
            checkAchievements();
        }
    }
}

function showAchievementToast(achievement) {
    setTimeout(() => {
        const toast = document.getElementById('achievement-toast');
        document.getElementById('toast-icon').innerText = achievement.icon;
        document.getElementById('toast-name').innerText = achievement.name;
        document.getElementById('toast-desc').innerText = achievement.desc;
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 4000);
    }, 2000);
}

function toggleAchievementsPanel() {
    const panel = document.getElementById('achievements-panel');
    const statsPanel = document.getElementById('stats-panel');
    
    if (statsPanel.classList.contains('show')) {
        statsPanel.classList.remove('show');
    }
    
    panel.classList.toggle('show');
    
    if (panel.classList.contains('show')) {
        renderAchievements();
    }
}

function renderAchievements() {
    const achievements = JSON.parse(localStorage.getItem('gmv_achievements') || '{}');
    const pagesContainer = document.getElementById('ach-pages-container');
    const paginationContainer = document.getElementById('ach-pagination');
    const counterEl = document.getElementById('ach-counter');
    
    let unlockedCount = 0;
    
    achievementsList.forEach(ach => {
        if (achievements[ach.id] || ach.check()) unlockedCount++;
    });
    
    counterEl.innerText = `${unlockedCount}/${achievementsList.length}`;
// Crear páginas
    const totalPages = Math.ceil(achievementsList.length / ACHIEVEMENTS_PER_PAGE);
    pagesContainer.innerHTML = '';
    paginationContainer.innerHTML = '';
    
    for (let pageNum = 0; pageNum < totalPages; pageNum++) {
        const page = document.createElement('div');
        page.className = 'ach-page';
        if (pageNum === currentAchPage) page.classList.add('active');
        
        const start = pageNum * ACHIEVEMENTS_PER_PAGE;
        const end = start + ACHIEVEMENTS_PER_PAGE;
        const pageAchs = achievementsList.slice(start, end);
        
        pageAchs.forEach(ach => {
            const isUnlocked = achievements[ach.id] || ach.check();
            const item = document.createElement('div');
            item.className = 'ach-item';
            if (isUnlocked) item.classList.add('unlocked');
            
            item.innerHTML = `
                <div class="ach-icon">${ach.icon}</div>
                <div class="ach-content">
                    <div class="ach-name">${ach.name}</div>
                    <div class="ach-desc">${ach.desc}</div>
                </div>
                <div class="ach-lock">🔒</div>
            `;
            page.appendChild(item);
        });
        
        pagesContainer.appendChild(page);
        
        // Pagination dot
        const dot = document.createElement('div');
        dot.className = 'page-dot';
        if (pageNum === currentAchPage) dot.classList.add('active');
        dot.onclick = () => {
            currentAchPage = pageNum;
            renderAchievements();
        };
        paginationContainer.appendChild(dot);
    }
}
        const svgIcons = {
            spotify: '<svg class="social-icon" viewBox="0 0 24 24"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141 4.32-1.32 9.779-.6 13.5 1.56.42.24.6.84.241 1.26zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.38 4.2-1.26 11.28-1.02 14.52 2.941.539.3.66 1.02.3 1.56-.24.479-1.02.6-1.56.3z"/></svg>',
            youtube: '<svg class="social-icon" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>'
        };

        var musicQueue = [];
        var commercialQueue = [];
        var lastPlayedMusicId = "";

        document.addEventListener('keydown', function(event) {
            if (isInputActive) return;
	    if (event.key === 'ArrowRight') nextChannel();
            if (event.key === 'ArrowLeft') previousChannel();
            if (event.key === 'ArrowUp') changeVolume(10);
            if (event.key === 'ArrowDown') changeVolume(-10);
            if (event.key === ' ' || event.key === 'Spacebar') {
                event.preventDefault();
                togglePause();
            }
// --- NUEVO: TECLA "1" PARA MINIMIZAR LA BARRA ---
// --- TECLA "1": OCULTA TODO (CONTROLES Y FAVORITOS) ---
            if (event.key === '1') {
                // 1. Ocultamos la barra de abajo
                const bar = document.getElementById('controlsBar');
                if (bar) bar.classList.toggle('minimized');

                // 2. Ocultamos el botón de favoritos de arriba
                const favBtnTop = document.querySelector('.fav-menu-btn-top');
                if (favBtnTop) favBtnTop.classList.toggle('minimized');
            }
// --- TECLA "0": MODO LIMPIO (VER VIDEO ORIGINAL) ---
            if (event.key === '0') {
                document.body.classList.toggle('clean-mode');
            }
 if (event.key.toLowerCase() === '2') {  
        toggleStatsPanel();
    }
if (event.key.toLowerCase() === '3') {
    toggleAchievementsPanel();
}
if (event.key === '5') {
    toggleFavorite();
}
if (event.key === '6') {
    toggleFavMenu();
}
if (event.key === '4') {
    openShareMenu();
}
        });

	function setVolume(val) { 
    if (player && player.setVolume) {
        player.setVolume(val); 
    }
    // Sincronizamos el slider visual (la bolita rosa)
    const slider = document.getElementById('volSlider');
    if (slider) slider.value = val;
    
    // Guardamos en la memoria para la próxima visita
    localStorage.setItem('gmv_volume', val);
}

	function changeVolume(delta) {
    if (player && player.getVolume) {
        let current = player.getVolume();
        let newVol = parseInt(current) + delta; // Aseguramos operación numérica
        if (newVol > 100) newVol = 100; 
        if (newVol < 0) newVol = 0;
        
        // Llamamos a la función maestra para que guarde y sincronice todo
        setVolume(newVol);
    }
}

        function togglePause() {
            if (!player) return;
            const state = player.getPlayerState();
            const btn = document.getElementById('playPauseBtn');
            if (state === YT.PlayerState.PLAYING) {
                player.pauseVideo(); 
                btn.innerHTML = "▶"; 
            } else {
                player.playVideo(); 
                btn.innerHTML = "⏸"; 
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getNextMusic() {
            if (typeof musicVideos === 'undefined' || musicVideos.length === 0) return null;
            if (musicQueue.length === 0) {
                musicQueue = [...musicVideos]; 
                shuffleArray(musicQueue);
                if (musicQueue.length > 1 && musicQueue[0].id === lastPlayedMusicId) {
                    musicQueue.push(musicQueue.shift());
                }
            }
            return musicQueue.shift();
        }

        function getNextCommercial() {
            if (typeof commercials === 'undefined' || commercials.length === 0) return null;
            if (commercialQueue.length === 0) {
                commercialQueue = [...commercials];
                shuffleArray(commercialQueue);
            }
            return commercialQueue.shift();
        }

function loadNewsFeed() {
            const ticker = document.getElementById('newsTicker');
            
            // Creamos el texto de YouTube
            const ytLabel = "<span style='color: #666; font-weight: 900; letter-spacing: 1px;'></span>";
            
            if (typeof newsItems !== 'undefined' && newsItems.length > 0) {
                // CAMBIO: Ahora las noticias van primero y el texto de YouTube al FINAL
                ticker.innerHTML = newsItems.join(' <span>●</span> ') + " &nbsp;&nbsp;&nbsp;&nbsp; " + ytLabel;
            } else {
                ticker.innerHTML = "<span>GMV NEWS:</span> Signal established... &nbsp;&nbsp;&nbsp;&nbsp;" + ytLabel;
            }
        }
loadNewsFeed();
	loadMessagesFromSheet();
	loadArtistAuth(); // Cargar artista autenticado si existe
	// --- TYPING SHORTCUTS EFFECT ---
const shortcuts = [
    '<span style="font-weight: 900;">PRESS [1]</span> HIDE UI',
    '<span style="font-weight: 900;">PRESS [2]</span> STATS',
    '<span style="font-weight: 900;">PRESS [3]</span> ACHIEVEMENTS',
    '<span style="font-weight: 900;">PRESS [4]</span> SHARE',
    '<span style="font-weight: 900;">PRESS [5]</span> ADD FAVORITE',
    '<span style="font-weight: 900;">PRESS [6]</span> FAVORITES MENU',
    '<span style="font-weight: 900;">PRESS [7]</span> INJECT SIGNAL',
    '<span style="font-weight: 900;">PRESS [8]</span> THE WALL',
    '<span style="font-weight: 900;">PRESS [9]</span> REWARDS'
];

let currentShortcutIndex = 0;
let isTyping = false;
let typingTimeout;

function typeShortcut(text, index, isDeleting) {
    const element = document.getElementById('shortcuts-typing');
    if (!element) return;
    
    const strippedText = text.replace(/<[^>]*>/g, '');
    
    if (isDeleting) {
        if (index > 0) {
            let displayText = '';
            let charCount = 0;
            let inTag = false;
            
            for (let i = 0; i < text.length && charCount < index - 1; i++) {
                if (text[i] === '<') inTag = true;
                displayText += text[i];
                if (text[i] === '>') inTag = false;
                if (!inTag && text[i] !== '<' && text[i] !== '>') charCount++;
            }
            
            element.innerHTML = displayText + '<span style="opacity: 0.5;">█</span>';
            typingTimeout = setTimeout(() => typeShortcut(text, index - 1, true), 30);
        } else {
            currentShortcutIndex = (currentShortcutIndex + 1) % shortcuts.length;
            typingTimeout = setTimeout(() => typeShortcut(shortcuts[currentShortcutIndex], 0, false), 500);
        }
    } else {
        if (index <= strippedText.length) {
            let displayText = '';
            let charCount = 0;
            let inTag = false;
            
            for (let i = 0; i < text.length && charCount < index; i++) {
                if (text[i] === '<') inTag = true;
                displayText += text[i];
                if (text[i] === '>') inTag = false;
                if (!inTag && text[i] !== '<' && text[i] !== '>') charCount++;
            }
            
            element.innerHTML = displayText + '<span style="opacity: 0.5;">█</span>';
            typingTimeout = setTimeout(() => typeShortcut(text, index + 1, false), 50);
        } else {
            // Cursor parpadeante cuando termina
            let blinkCount = 0;
            const blinkInterval = setInterval(() => {
                if (blinkCount % 2 === 0) {
                    element.innerHTML = text + '<span style="opacity: 0.5;">█</span>';
                } else {
                    element.innerHTML = text + '<span style="opacity: 0;">█</span>';
                }
                blinkCount++;
                if (blinkCount >= 8) {
                    clearInterval(blinkInterval);
                    typingTimeout = setTimeout(() => typeShortcut(text, strippedText.length, true), 500);
                }
            }, 250);
        }
    }
}

// Iniciar efecto typing
setTimeout(() => typeShortcut(shortcuts[0], 0, false), 1000);
	
	// Recargar mensajes cada 5 segundos (más tiempo para que Google procese)
	setInterval(loadMessagesFromSheet, 5000); 

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%', 
                width: '100%',
                playerVars: { 
                    'controls': 0, 
                    'rel': 0, 
                    'playsinline': 1, 
                    'iv_load_policy': 3, 
                    'fs': 0, 
                    'disablekb': 1 
                },
                events: { 
                    'onReady': onPlayerReady, 
                    'onStateChange': onPlayerStateChange, 
                    'onError': onPlayerError 
                }
            });
        }
	

	// Esto detecta si la API ya estaba cargada antes de que el código despertara
if (window.YT && window.YT.Player) {
    onYouTubeIframeAPIReady();
}

	function onPlayerReady(event) {
    playerReady = true;
    
    // Intentamos recuperar el volumen guardado
    const savedVol = localStorage.getItem('gmv_volume');
    const finalVol = (savedVol !== null) ? parseInt(savedVol) : 100;
    
    // Aplicamos el volumen recuperado a través de nuestra función maestra
    setVolume(finalVol);
    
    console.log("✅ TV READY - Volume restored to:", finalVol);
}

function startTV() {
    // Verificar si ya tiene username guardado
    const savedUsername = localStorage.getItem('gmv_username');
    
    if (!savedUsername) {
        // Primera vez - mostrar modal de login
        document.getElementById('login-modal').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('username-input').focus();
        }, 300);
        return;
    }
    
    // Ya tiene username - iniciar normalmente
    if (playerReady) {
        var elem = document.documentElement;
        if (elem.requestFullscreen) { 
            elem.requestFullscreen().catch(err => console.log(err)); 
        } else if (elem.webkitRequestFullscreen) { 
            elem.webkitRequestFullscreen(); 
        }

        const screen = document.getElementById('start-screen');
        screen.style.opacity = '0';
        setTimeout(() => { 
            screen.style.display = 'none'; 
        }, 800);
        
        document.getElementById('tvOverlay').style.display = 'block';
        document.getElementById('controlsBar').style.display = 'flex'; 
        playNextVideo();
        startPromoCycle(); 
    } else {
        const btn = document.querySelector('.enter-btn');
        btn.innerText = "...";
        setTimeout(() => btn.innerText = "PLAY", 2000);
    }
}

function saveUsername() {
    const input = document.getElementById('username-input');
    const username = input.value.trim();
    
    if (username.length < 3) {
        showSystemMessage('⚠️ USERNAME TOO SHORT (MIN 3 CHARS)');
        input.focus();
        return;
    }
    
    // Guardar username
    localStorage.setItem('gmv_username', username);
    
    // Ocultar modal de login
    document.getElementById('login-modal').classList.add('hidden');
    
    // Mostrar mensaje de bienvenida
    showSystemMessage('👋 WELCOME ' + username.toUpperCase() + '!');
    
    // Iniciar TV después de 1 segundo
    setTimeout(() => {
        if (playerReady) {
            var elem = document.documentElement;
            if (elem.requestFullscreen) { 
                elem.requestFullscreen().catch(err => console.log(err)); 
            } else if (elem.webkitRequestFullscreen) { 
                elem.webkitRequestFullscreen(); 
            }

            const screen = document.getElementById('start-screen');
            screen.style.opacity = '0';
            setTimeout(() => { 
                screen.style.display = 'none'; 
            }, 800);
            
            document.getElementById('tvOverlay').style.display = 'block';
            document.getElementById('controlsBar').style.display = 'flex'; 
            playNextVideo();
            startPromoCycle();
        }
    }, 1000);
}

// Permitir Enter en el input de username
document.addEventListener('DOMContentLoaded', function() {
    const usernameInput = document.getElementById('username-input');
    if (usernameInput) {
        usernameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveUsername();
            }
        });
    }
});

        function onPlayerStateChange(event) {
	// --- NUEVO: ANTI-ROBO DE FOCO ---
        // Si el video se pausa o termina, quitamos el foco de YouTube y lo devolvemos a la web
        if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
            document.activeElement.blur(); // Saca el foco del Iframe
            window.focus(); // Lo devuelve a tu página
        }
        // --------------------------------
            if (event.data === YT.PlayerState.ENDED) playNextVideo();
            if (event.data === YT.PlayerState.PLAYING) document.getElementById('playPauseBtn').innerHTML = "⏸";
        }

        function onPlayerError(event) { 
            playNextVideo(); 
        }

        function playNextVideo() {
            isGoingBack = false;
           if (videoCount >= nextCommercialTarget && !isCommercial) {
                playCommercial();
            } else {
                playMusic();
            }
        }

        function previousChannel() {
            if (historyStack.length > 1) {
                isGoingBack = true; 
                historyStack.pop();
                const prevVideo = historyStack.pop();
                playSpecificVideo(prevVideo, false);
            }
        }

        function playMusic() {
            isCommercial = false;
            videoCount++;
            const video = getNextMusic();
            if (video) playSpecificVideo(video, true);
            else alert("Error: No videos");
        }

	function playSpecificVideo(video, addToHistory) {      
            currentVideo = video;
            
            // 1. Definir variables necesarias para el envío (EL ARREGLO)
            const username = localStorage.getItem('gmv_username') || 'GUEST';
            const levelInfo = calculateLevel(statsData.permanentAchievements);
            const onlyLevelName = levelInfo.title.split(' - ')[1] || levelInfo.title;
		
		// Revisamos qué logros tiene el usuario guardados
            const userAchievements = JSON.parse(localStorage.getItem('gmv_achievements') || '{}');
            const achievementsStatus = achievementsList.map(ach => ({
                id: ach.id,
                name: ach.name,
                icon: ach.icon,
                unlocked: !!userAchievements[ach.id]
            }));
		const currentFavs = JSON.parse(localStorage.getItem('gmv_favorites') || '[]');
            const isFavorite = currentFavs.includes(currentVideo.id);

            // ENVIAR SEÑAL AL CELULAR CON EL NOMBRE DE LA CANCIÓN
            socket.emit('enviar-comando', { 
                cmd: 'update-track', 
                title: video.title, 
                artist: video.artist, 
                room: myRoom 
            });

            // Calcular tiempo formateado para el celular
            const hours = Math.floor(statsData.totalMinutes / 60);
            const mins = statsData.totalMinutes % 60;
            const timeStr = `${hours}h ${mins}m`;

            // Enviar actualización de usuario y estadísticas al celular
            socket.emit('enviar-comando', {
                cmd: 'update-user-data',
                username: username.toUpperCase(),
                level: onlyLevelName.toUpperCase(),
                totalVideos: statsData.totalVideos,
                watchTime: timeStr,
		streak: statsData.currentStreak,
		achievements: achievementsStatus,
		isFavorite: isFavorite,
                room: myRoom
            });

            if (viewTimer) clearTimeout(viewTimer);
            lastPlayedMusicId = video.id;
            checkNightOwl();
            checkEarlyBird(video);

            if (addToHistory) {
                historyStack.push(video);
                if (historyStack.length > 50) historyStack.shift();

                viewTimer = setTimeout(() => {
                    trackVideoView(video);
                    checkAchievements();
                    totalViewsForRewards = statsData.totalVideos;
                    updateRewardsUI();
                    console.log("View counted for: " + video.title);
                }, MIN_WATCH_TIME);
            }
            
            // 2. Ahora sí, cargar el video (Esta línea ya no se bloqueará)
            player.loadVideoById(video.id);
            
            const trackBox = document.getElementById('trackInfoBox');
            trackBox.style.animation = 'none';
            setTimeout(() => {
                trackBox.style.animation = 'slideInLeft 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
            }, 10);
            
            document.getElementById('songTitle').innerText = video.title;
            document.getElementById('artistName').innerText = video.artist;
            document.getElementById('trackInfoBox').style.display = 'block';

            const badge = document.getElementById('dynamicBadge');
            badge.className = 'info-badge'; 

            if (video.badgeText) {
                badge.innerText = video.badgeText;
                badge.classList.add('badge-' + (video.badgeColor || 'blue'));
                badge.style.display = "block";
            } else {
                badge.style.display = "none";
            }

            const socialContainer = document.getElementById('topSocialLinks');
            socialContainer.innerHTML = "";
            document.querySelector('.interaction-container').style.display = 'flex';
            
            if (video.artistId && typeof artistProfiles !== 'undefined' && artistProfiles[video.artistId]) {
                const profile = artistProfiles[video.artistId];
                profile.links.forEach(link => {
                    if (svgIcons[link.name.toLowerCase()]) {
                        const a = document.createElement('a');
                        a.href = link.url; 
                        a.target = "_blank";
                        a.innerHTML = svgIcons[link.name.toLowerCase()];
                        socialContainer.appendChild(a);
                    }
                });
            }
            
            updateInteractionState(video);
        }

        function playCommercial() {
            isCommercial = true; 
	    nextCommercialTarget = videoCount + Math.floor(Math.random() * 3) + 3;
            currentVideo = null;
            const commercialId = getNextCommercial();
            
            document.getElementById('topSocialLinks').innerHTML = ""; 
            document.querySelector('.interaction-container').style.display = 'none';
            document.getElementById('trackInfoBox').style.display = 'none';
            
            const badge = document.getElementById('dynamicBadge');
            if(badge) badge.style.display = 'none';
            
            if (commercialId) player.loadVideoById(commercialId);
            else playMusic();
        }

        function updateInteractionState(video) {
            const favBtn = document.getElementById('favBtn');
            const favorites = JSON.parse(localStorage.getItem('gmv_favorites') || "[]");
            if (favorites.includes(video.id)) {
                favBtn.classList.add('favorited');
            } else {
                favBtn.classList.remove('favorited');
            }
        }

        function toggleFavorite() {
            if (!currentVideo || isCommercial) return;
            
            let favorites = JSON.parse(localStorage.getItem('gmv_favorites') || "[]");
            const vidId = currentVideo.id;
            const favBtn = document.getElementById('favBtn');
            
            if (favorites.includes(vidId)) {
                favorites = favorites.filter(id => id !== vidId);
                favBtn.classList.remove('favorited');
            } else {
                favorites.push(vidId);
                favBtn.classList.add('favorited');
            }
            
            localStorage.setItem('gmv_favorites', JSON.stringify(favorites));
            renderFavoritesMenu();
	    checkAchievements();
        }

        function toggleFavMenu() {
            const menu = document.getElementById('favorites-modal');
            menu.classList.toggle('open');
            if (menu.classList.contains('open')) renderFavoritesMenu();
        }

        function renderFavoritesMenu() {
            const listContainer = document.getElementById('fav-list-content');
            const favorites = JSON.parse(localStorage.getItem('gmv_favorites') || "[]");
            listContainer.innerHTML = "";
            
            if (favorites.length === 0) {
                listContainer.innerHTML = '<div class="no-favs">No saved videos yet.</div>';
                return;
            }
            
            favorites.forEach(favId => {
                const vidData = musicVideos.find(v => v.id === favId);
                if (vidData) {
                    const item = document.createElement('div');
                    item.className = 'fav-item';
                    item.onclick = () => {
                        document.getElementById('favorites-modal').classList.remove('open');
                        playSpecificVideo(vidData, true);
                    };
                    item.innerHTML = `
                        <div class="fav-item-title">▶ ${vidData.title}</div>
                        <div class="fav-item-artist">${vidData.artist}</div>
                    `;
                    listContainer.appendChild(item);
                }
            });
        }

        function playAllFavorites() {
            const favorites = JSON.parse(localStorage.getItem('gmv_favorites') || "[]");
            if (favorites.length === 0) { 
                alert("Add videos to favorites first."); 
                return; 
            }
            
            const favVideosList = musicVideos.filter(v => favorites.includes(v.id));
            musicQueue = [...favVideosList];
            shuffleArray(musicQueue);
            toggleFavMenu();
            playNextVideo();
        }

        function nextChannel() { 
            playNextVideo(); 
        }

        function showRandomPromo() {
            if (typeof promoItems === 'undefined' || promoItems.length === 0) return;
            if (isCommercial || !currentVideo) return; 

            const promo = promoItems[Math.floor(Math.random() * promoItems.length)];
            const imgEl = document.getElementById('promoImage');
            
            if (promo.img) { 
                imgEl.src = promo.img; 
                imgEl.style.display = "block"; 
            } else { 
                imgEl.style.display = "none"; 
            }

            document.getElementById('promoTitle').innerText = promo.title;
            document.getElementById('promoMsg').innerText = promo.msg;

            const card = document.getElementById('promoCard');
            card.classList.add('show');
            
            setTimeout(() => { 
                card.classList.remove('show'); 
            }, 10000); 
        }

        function startPromoCycle() {
            setTimeout(showRandomPromo, 30000); 
            promoInterval = setInterval(showRandomPromo, 900000);
        }

	// --- SHARE SYSTEM ---
function openShareMenu() {
    if (!currentVideo || isCommercial) {
        showSystemMessage("⚠️ NO VIDEO PLAYING");
        return;
    }
    
    const modal = document.getElementById('share-modal');
    modal.classList.add('show');
    isInputActive = true;
}

function closeShareMenu() {
    const modal = document.getElementById('share-modal');
    modal.classList.remove('show');
    isInputActive = false;
}

function shareOn(platform) {
    if (!currentVideo) return;
    
    const artist = currentVideo.artist;
    const title = currentVideo.title;
    const message = `🎵 I'm listening to: ${artist} - ${title} on www.generativemusicvideo.com and I love it! 🎵`;
    const url = 'https://www.generativemusicvideo.com';
    
    let shareUrl = '';
    
switch(platform) {
        case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
            break;
case 'facebook':
    const fbMessage = `🎵 I'm listening to: ${artist} - ${title} on www.generativemusicvideo.com and I love it! 🎵`;
    navigator.clipboard.writeText(fbMessage).then(() => {
        showSystemMessage('📋 COPIED! OPENING FACEBOOK...');
        setTimeout(() => {
            window.open('https://www.facebook.com/', '_blank');
        }, 1500);
    });
    closeShareMenu();
    return;
        case 'whatsapp':
            shareUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            break;
case 'telegram':
    shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(message)}`;
    break;
	case 'copy':
    navigator.clipboard.writeText(message).then(() => {
        showSystemMessage('📋 TEXT COPIED TO CLIPBOARD!');
    }).catch(() => {
        showSystemMessage('❌ COPY FAILED - TRY MANUALLY');
    });
    closeShareMenu();
    return;
    }
    
    window.open(shareUrl, '_blank', 'width=600,height=400');
    showSystemMessage('🚀 SHARING ON ' + platform.toUpperCase());
}

// Cerrar con ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const shareModal = document.getElementById('share-modal');
        if (shareModal && shareModal.classList.contains('show')) {
            closeShareMenu();
        }
    }
});

// --- LÓGICA PARA OBTENER EL RANKING DE GOOGLE SHEETS ---
const rankingURL = "https://script.google.com/macros/s/AKfycbzD2iB1rAJ-LSbLvfA2hrIXbymgn2PYWFVTdNi7aok-zuODRy0sffvfiYUAdQSBHzcEKQ/exec";
let rankingVisible = false;

async function toggleRanking() {
    const panel = document.getElementById('ranking-panel');
    const content = document.getElementById('ranking-list-content');

    if (rankingVisible) {
        panel.classList.remove('show');
        rankingVisible = false;
    } else {
        panel.classList.add('show');
        rankingVisible = true;
        
        // Mensaje de carga inicial
        content.innerHTML = '<div style="text-align:center; color:#FFD700; padding:20px; font-size:0.8rem;">LOADING DATA...</div>';

        try {
            // Pedimos los datos a Google
            const response = await fetch(`${rankingURL}?action=getTop10`);
            const data = await response.json();

            if (data.length === 0) {
                content.innerHTML = '<div style="text-align:center; color:#555; padding:20px;">NO VOTES RECORDED</div>';
                return;
            }

            // Construimos la lista visual
            let html = "";
            data.forEach((item, index) => {
                // Solo mostrar si hay un nombre de artista
                if(item.artist) {
                    html += `
                        <div class="ranking-item">
                            <div class="rank-number">#${index + 1}</div>
                            <div class="rank-info">
                                <div class="rank-artist">${item.artist}</div>
                                <div style="font-size:0.7rem; color:#888;">${item.title}</div>
                            </div>
                            <div class="rank-votes">${item.votes} PTS</div>
                        </div>
                    `;
                }
            });
            content.innerHTML = html;

        } catch (error) {
            console.error("Error al obtener ranking:", error);
            content.innerHTML = '<div style="text-align:center; color:#ff4444; padding:20px;">CONNECTION ERROR</div>';
        }
    }
}
</script>
<script>
    // --- PROTECCIÓN BÁSICA ---
    document.addEventListener('contextmenu', event => event.preventDefault()); // Bloquea Clic Derecho

    document.onkeydown = function(e) {
        // Bloquea F12 (Consola)
        if(e.keyCode == 123) { return false; }
        // Bloquea Ctrl+I (Inspeccionar)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)){ return false; }
        // Bloquea Ctrl+J (Consola)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)){ return false; }
        // Bloquea Ctrl+U (Ver código fuente)
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)){ return false; }
    }
// --- CHEAT CODE (SYSTEM OVERRIDE & RESTORE) ---
    let keyBuffer = ""; 
    const secretWord = "dream"; 
    const resetWord = "reset";

    document.addEventListener('keydown', function(event) {
        if (isInputActive) return;
	keyBuffer += event.key;
        // Mantenemos el buffer limpio
        if (keyBuffer.length > 20) keyBuffer = keyBuffer.slice(-20);

        // --- ACTIVAR (Palabra: dream) ---
        if (keyBuffer.includes(secretWord)) {
            console.log("CHEAT ACTIVATED");
            
            if(typeof statsData !== 'undefined') {
                // 1. Guardamos tu número real en una memoria temporal (Backup)
                // (Solo si es un número normal, para no guardar el 999 por error)
                if(statsData.monthlyVideos < 900) {
                    localStorage.setItem('backup_videos_reales', statsData.monthlyVideos);
                }

                // 2. Activamos el truco visual
                statsData.monthlyVideos = 999; 
                totalViewsForRewards = 999;
                
                // OJO: NO tocamos statsData.totalVideos. Tu historial está a salvo.
                saveStats();
            }

            updateRewardsUI();
            showSystemMessage("🔓 SYSTEM OVERRIDE: UNLOCKED");
            keyBuffer = "";
        }

        // --- RESTAURAR (Palabra: reset) ---
        if (keyBuffer.includes(resetWord)) {
            console.log("SYSTEM RESET");

            if(typeof statsData !== 'undefined') {
                // 1. Buscamos el número que guardamos antes
                let numeroGuardado = localStorage.getItem('backup_videos_reales');
                
                // 2. Si existe, lo restauramos. Si no, ponemos 0.
                if(numeroGuardado !== null) {
                    statsData.monthlyVideos = parseInt(numeroGuardado);
                } else {
                    statsData.monthlyVideos = 0;
                }
                
                totalViewsForRewards = statsData.monthlyVideos;
                saveStats();
            }

            updateRewardsUI();
            
            // Mostramos mensaje confirmando el número recuperado
            showSystemMessage("🔄 SYSTEM RESTORED: " + statsData.monthlyVideos + " VIEWS");
            keyBuffer = "";
        }

// --- AUTENTICACIÓN DE ARTISTAS Y ADMIN ---
        // Revisar admin key
        if (keyBuffer.includes(adminKey)) {
            saveArtistAuth("GMV", "admin");
            showSystemMessage("👑 ADMIN ACCESS GRANTED: GMV");
            keyBuffer = "";
        }
        
        // Revisar claves de artistas
        for (let clave in artistRegistry) {
            if (keyBuffer.includes(clave)) {
                const artist = artistRegistry[clave];
                saveArtistAuth(artist.name, artist.type);
                showSystemMessage("💎 ARTIST ACCESS GRANTED: " + artist.name);
                keyBuffer = "";
                break;
            }
        }
    });
function showSystemMessage(text) {
        const msgBox = document.getElementById('sys-notification');
        if (msgBox) {
            msgBox.innerText = text; // Usamos innerText para asegurar texto plano
            msgBox.classList.remove('hidden');
            msgBox.classList.add('visible');

            // Ocultar automáticamente después de 3 segundos
            setTimeout(() => {
                msgBox.classList.remove('visible');
                msgBox.classList.add('hidden');
            }, 3000);
        }
    }

// --- PEGA DESDE AQUÍ ---
function loadGlobalVisits() {
        // PEGA AQUÍ LA NUEVA URL QUE COPIASTE EN EL PASO 1
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxHjlheSdOJC7qd0rM0mB5uMqERwdsoCq20D4F1kIblvbo9mKEc2mhYVOcEvRqidrVhLw/exec';

        fetch(scriptURL)
            .then(response => response.text())
            .then(data => {
                const formatted = data.padStart(6, '0');
                const counterElement = document.getElementById('visit-count');
                if (counterElement) {
                    counterElement.innerText = formatted;
                }
            })
            .catch(err => {
                document.getElementById('visit-count').innerText = 'OFFLINE';
            });
    }
   
window.addEventListener('load', loadGlobalVisits);

// --- LÓGICA DE LA TECLA "Q" PARA EL QR ---
const qrURL = `https://soloparapruebas.netlify.app/control-remoto.html?room=${myRoom}`;

    setTimeout(() => {
        const qrDiv = document.getElementById("qrcode");
        if (qrDiv) {
            new QRCode(qrDiv, { text: qrURL, width: 250, height: 250 });
        }
    }, 1000);

// 2. Escuchar la tecla "Q" (Ahora con mensaje de aviso)
    document.addEventListener('keydown', (e) => {
        if (e.key.toLowerCase() === 'q') {
            const overlay = document.getElementById('qr-overlay');
            if (overlay) {
                // Si el QR está oculto, lo mostramos y avisamos
                if (overlay.style.display === 'none' || overlay.style.display === '') {
                    overlay.style.display = 'flex';
                    } 
                // Si el QR está visible, lo ocultamos y avisamos
                else {
                    overlay.style.display = 'none';
                }
            }
        }
    });

// --- RECEPTOR DE SEÑAL Y COMANDOS (BLOQUE CORREGIDO) ---

// 1. Manejo de conexión y sincronización inicial
socket.on('connect', () => {
    console.log("📡 SIGNAL ESTABLISHED - ID:", socket.id);
    socket.emit('join-room', myRoom);
    
    // Enviamos la canción actual al control en cuanto conecte
    if (currentVideo) {
        socket.emit('enviar-comando', { 
            cmd: 'update-track', 
            title: currentVideo.title, 
            artist: currentVideo.artist, 
            room: myRoom 
        });
    }
});

// 2. Escucha de comandos del control remoto
// --- RECEPTOR DE SEÑAL Y COMANDOS (CORREGIDO) ---
socket.on('ejecutar-comando', (data) => {
    console.log('📩 Orden recibida:', data.cmd);
    
    switch(data.cmd) {
        case 'sync':
            if (currentVideo) {
                socket.emit('enviar-comando', { 
                    cmd: 'update-track', 
                    title: currentVideo.title, 
                    artist: currentVideo.artist, 
                    room: myRoom 
                });
            }

            const usernameSync = localStorage.getItem('gmv_username') || 'GUEST';
            const levelInfoSync = calculateLevel(statsData.permanentAchievements);
            const levelNameSync = levelInfoSync.title.split(' - ')[1] || levelInfoSync.title;
            const hSync = Math.floor(statsData.totalMinutes / 60);
            const mSync = statsData.totalMinutes % 60;
            const timeStrSync = `${hSync}h ${mSync}m`;

            const userAchSync = JSON.parse(localStorage.getItem('gmv_achievements') || '{}');
            const achStatusSync = achievementsList.map(ach => ({
                id: ach.id,
                name: ach.name,
                icon: ach.icon,
                unlocked: !!userAchSync[ach.id]
            }));

            const currentFavsSync = JSON.parse(localStorage.getItem('gmv_favorites') || '[]');
            const isFavoriteSync = currentVideo ? currentFavsSync.includes(currentVideo.id) : false;

            socket.emit('enviar-comando', {
                cmd: 'update-user-data',
                username: usernameSync.toUpperCase(),
                level: levelNameSync.toUpperCase(),
                totalVideos: statsData.totalVideos,
                watchTime: timeStrSync,
                streak: statsData.currentStreak,
                achievements: achStatusSync, 
                isFavorite: isFavoriteSync,
                room: myRoom
            });
            break;

	case 'voice-search':
            if (data.query) {
                const busqueda = data.query.toLowerCase().trim();
                
                // Buscamos en musicVideos (que ya tiene tus datos de Google Sheets)
                const coincidencias = musicVideos.filter(v => 
                    v.artist.toLowerCase().includes(busqueda) || 
                    v.title.toLowerCase().includes(busqueda)
                );

                if (coincidencias.length > 0) {
                   const elegido = coincidencias[Math.floor(Math.random() * coincidencias.length)];
                    
                    showSystemMessage("🔍 ENCONTRADO: " + elegido.artist.toUpperCase());
                    playSpecificVideo(elegido, true); 
                } else {
                    showSystemMessage("🚫 NO ENCONTRADO: " + data.query.toUpperCase());
                }
            }
            break;

		case 'vote':
            	if (data.voteType) {
                triggerVoteAnimation(data.voteType); // Sigue haciendo la animación
                injectVoteToSheet(data.voteType);    // <--- AHORA TAMBIÉN INYECTA EL VOTO
            }
            break;
            
        case 'next': nextChannel(); break;
        case 'prev': previousChannel(); break;
        case 'pause': togglePause(); break;
        case 'vol-up': changeVolume(10); break;
        case 'vol-down': changeVolume(-10); break;
        case 'favorite': toggleFavorite(); break;
        case 'stats': toggleStatsPanel(); break;
        case 'achievements': toggleAchievementsPanel(); break;
        case 'minimize': {
            const bar = document.getElementById('controlsBar');
            if (bar) bar.classList.toggle('minimized');
            const favBtnTop = document.querySelector('.fav-menu-btn-top');
            if (favBtnTop) favBtnTop.classList.toggle('minimized');
            break;
        }
        case 'share': openShareMenu(); break;
        case 'fav-menu': toggleFavMenu(); break;
        case 'marquee': toggleMarqueeContent(); break;
        case 'rewards': toggleRewardsSidebar(); break;
        case 'muro-broadcast':
            if (data.texto) sendSignalToWall(data.texto); 
            break;
	case 'mute':
            if (player && player.getVolume) {
                if (player.getVolume() > 0) {
                    player.setVolume(0);
                    document.getElementById('volSlider').value = 0;
                } else {
                    player.setVolume(100);
                    document.getElementById('volSlider').value = 100;
                }
            }
            break;
        case 'top-10': toggleRanking(); break;
        case 'play-favs': playAllFavorites(); break;
        case 'esc': 
            closeShareMenu(); 
            closeSignalOverlay(); 
            document.getElementById('qr-overlay').style.display = 'none';
            break;
    }
});

function triggerVoteAnimation(type) {
            const layer = document.getElementById('animation-layer');
            if (!layer) return;

            // Definimos los bandos
            const posIcons = ['💜', '💖', '✨', '🔥', '🎵', '👍', '😍'];
            const negIcons = ['👎', '💩', '🤮', '💀', '🚫', '📉', '🖕'];
            
            const icons = (type === 'up') ? posIcons : negIcons;
            const shadowColor = (type === 'up') ? 'rgba(255, 0, 85, 0.5)' : 'rgba(0, 255, 100, 0.5)';

            for (let i = 0; i < 70; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.className = 'vote-particle';
                    el.innerText = icons[Math.floor(Math.random() * icons.length)];
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.filter = `drop-shadow(0 0 10px ${shadowColor})`;
                    
                    const size = (Math.random() * (2.5 - 1.5) + 1.5).toFixed(1);
                    el.style.fontSize = size + 'rem';
                    
                    const duration = (Math.random() * (5 - 3) + 3).toFixed(1);
                    el.style.animationDuration = duration + 's';

                    layer.appendChild(el);
                    setTimeout(() => el.remove(), 5000);
                }, i * 110);
            }
        }

	function toggleQRDesdeIcono() {
    const overlay = document.getElementById('qr-overlay');
    if (overlay) {
        overlay.style.display = (overlay.style.display === 'none' || overlay.style.display === '') ? 'flex' : 'none';
    }
}

// Función para mandar el voto a Google Sheets
function injectVoteToSheet(type) {
    if (!currentVideo || !currentVideo.id) return;

    const scriptURL = 'https://script.google.com/macros/s/AKfycbzD2iB1rAJ-LSbLvfA2hrIXbymgn2PYWFVTdNi7aok-zuODRy0sffvfiYUAdQSBHzcEKQ/exec';
    const finalURL = `${scriptURL}?id=${currentVideo.id}&type=${type}`;

    fetch(finalURL, { mode: 'no-cors' })
        .catch(err => console.error("Error inyectando voto:", err));
}
</script>

<div id="signal-input-overlay" class="sys-msg hidden" style="top: 50%; height: auto; pointer-events: auto;">
    <div style="color: #ff0055; margin-bottom: 10px;">[ INJECT SIGNAL INTO WALL ]</div>
    <input type="text" id="signal-input-field" 
           style="background: #000; border: 1px solid #ff0055; color: #ff0055; width: 100%; padding: 10px; font-family: 'JetBrains Mono', monospace; outline: none;" 
           placeholder="WRITE YOUR MESSAGE..." maxlength="100">
    <div style="font-size: 0.7rem; color: #555; margin-top: 10px;">PRESS [ENTER] TO SEND OR [ESC] TO CANCEL</div>
</div>

<div id="share-modal">
    <div class="share-header">📡 SHARE THIS TRACK</div>
    <div class="share-buttons">
        <button class="share-btn twitter" onclick="shareOn('twitter')">🐦 Twitter</button>
        <button class="share-btn facebook" onclick="shareOn('facebook')">📘 Facebook</button>
        <button class="share-btn whatsapp" onclick="shareOn('whatsapp')">💬 WhatsApp</button>
        <button class="share-btn telegram" onclick="shareOn('telegram')">✈️ Telegram</button>
        <button class="share-btn copy" onclick="shareOn('copy')">📋 Copy Text</button>
    </div>
    <button class="share-close" onclick="closeShareMenu()">CLOSE [ESC]</button>
</div>

<div id="sys-notification" class="sys-msg hidden">🔓 SYSTEM OVERRIDE: ACCESS GRANTED</div>

<div id="qr-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(8px);">
    <div id="qrcode" style="padding: 20px; background: white; border-radius: 15px; border: 4px solid #ff0055;"></div>
    <p style="margin-top: 20px; font-family: 'Bebas Neue', sans-serif; color: #ff0055;">SCAN TO CONNECT</p>
</div>
</body>
</html>